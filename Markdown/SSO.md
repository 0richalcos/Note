# 1、引言与基础

#### 1.1 什么是单点登录 (SSO)？

**单点登录（Single Sign-On）** 是一种身份认证的集成方案。它允许用户在多个独立的软件系统中，仅使用**一组身份凭证（如用户名和密码）登录一次**，便能无缝访问所有相互信任的应用系统，而无需在每个系统上重复进行登录操作。其核心价值在于提升用户体验、简化密码管理和增强系统安全性。

#### **1.2 SSO 的核心角色**

- 
- **用户 (User)**: 需要访问系统的最终使用者。
- **身份提供商 (Identity Provider, IdP)**: 系统的“认证中心”，负责验证用户身份、管理用户凭证。
- **服务提供商 (Service Provider, SP)**: 用户希望访问的业务应用系统，它信任 IdP 的认证结果。

------



### **2. 主流 SSO 协议概览**

协议是实现 SSO 的“通用语言”，它定义了 IdP 和 SP 之间如何安全地通信和交换认证信息。理解协议是理解现代 SSO 方案的基石。

#### **2.1 OpenID Connect (OIDC) 1.0**

- 
- **定位**: **现代 Web/App 身份认证的事实标准**。
- **基础**: 构建在 **OAuth 2.0** 授权框架之上的一层**身份认证协议**。
- **核心**: 通过引入 **ID Token**（一个 JWT 格式的令牌）来传递用户的身份信息，解决了 OAuth 2.0 只管“授权”不管“认证”的问题。
- **特点**: 基于 REST/JSON，轻量级，安全性高，生态完善。

#### **2.2 SAML (Security Assertion Markup Language) 2.0**

- 
- **定位**: **企业级和联邦认证的成熟标准**。
- **基础**: 基于 XML 的标记语言，用于交换认证和授权“断言 (Assertions)”。
- **核心**: IdP 将一个经过数字签名的 XML 文档（SAML Response）发送给 SP，SP 验证该文档以确认用户身份。
- **特点**: 功能强大但配置繁琐，在企业级集成中广泛应用，对移动端不友好。

#### **2.3 CAS (Central Authentication Service)**

- 
- **定位**: **一个具体的协议，也是一个开源项目**，专注于 SSO 场景。
- **基础**: 自成体系的协议，通过浏览器重定向和“票据 (Ticket)”机制工作。
- **核心**: IdP 颁发一次性的服务票据（ST），SP 必须通过后端服务调用来验证此票据的有效性。
- **特点**: 架构清晰，安全性高，但在通用性上不如 OIDC 和 SAML。

------



### **3. SSO 核心实现模式与协议应用**

下面，我们将各种实现模式与其背后通常应用的协议关联起来，进行深度解析。

### **3.1 模式一：基于共享存储的模式 (非标、有状态)**

这种模式**不遵循任何标准 SSO 协议**，是一种自定义的、内部的实现方式，依赖于系统间的强耦合。

#### **3.1.1 子模式：同主域共享 Cookie**

- 
- **关联协议**: **无**。这是一种纯粹的、利用浏览器特性的技巧。
- **工作原理**:
  1. 
  2. 用户在统一的登录域名（如 login.example.com）下登录。
  3. IdP 在认证成功后，向浏览器写入一个 Cookie，并将其 Domain 属性设置为主域名 .example.com。
  4. 当用户访问同一主域名下的其他业务系统时（如 app1.example.com），浏览器会自动携带这个主域 Cookie。
  5. 业务系统的后端读取并验证这个共享 Cookie，从而确认用户身份。
- **优点**:
  - 
  - **实现简单**: 无需复杂的协议，逻辑直观，开发快速。
- **缺点**:
  - 
  - **强依赖主域名**: 致命缺陷，无法支持不同主域名的系统。
  - **高耦合**: 所有应用必须约定并理解同一个 Cookie 的格式和内容。
  - **安全性较低**: Cookie 直接暴露在浏览器，易受 CSRF、XSS 攻击。
  - **非浏览器环境不友好**: 无法用于原生 App、小程序等场景。
- **适用场景**:
  - 
  - 仅限于全部署在同一主域名下的、**简单的、非核心的内部系统**。在现代架构中已基本被淘汰。

#### **3.1.2 子模式：后端共享 Session**

- 
- **关联协议**: **无**。同样是一种自定义方案。
- **工作原理**:
  1. 
  2. 用户在 IdP 登录后，IdP 创建一个 Session，并将 Session 数据存入一个**中心化存储介质**（如 Redis）。
  3. IdP 将与该 Session 关联的唯一 ID 通过 URL 重定向等方式传递给目标 SP。
  4. SP 接收到 ID 后，以后端服务访问 Redis，获取完整的用户信息，并创建自己的本地会话。
- **优点**:
  - 
  - **解决跨域问题**: 通过后端传递 ID，不再受浏览器同源策略限制。
  - **相对安全**: 浏览器中的凭证只是一个无意义的 ID，敏感信息存储在后端。
- **缺点**:
  - 
  - **有状态服务**: 所有系统都强依赖后端的共享存储，增加了系统复杂性和潜在的性能瓶颈。
  - **重度耦合**: 所有 SP 都必须能连接并访问该共享存储，违反了微服务的高内聚低耦合原则。
- **适用场景**:
  - 
  - 应用数量不多的中小型项目，在微服务架构普及前较为常见。**不推荐在新项目中使用**。

------



### **3.2 模式二：基于重定向的票据/断言模式 (经典)**

这种模式是 SSO 的经典实现，通过浏览器重定向来协调 IdP 和 SP，并在后端安全地验证身份。

#### **3.2.1 子模式：票据验证 (Ticket Validation)**

- 
- **关联协议**: **CAS 协议**。
- **工作原理**:
  1. 
  2. **访问与重定向**: 用户访问 SP，SP 发现未登录，将其重定向到 IdP，并附带 service (回调地址) 参数。
  3. **登录与票据生成**: 用户在 IdP 登录。IdP 创建全局会话(TGT)，生成一次性服务票据(ST)，然后将用户重定向回 SP 的 service 地址，并附上 ticket=ST-xxxx。
  4. **后端验证**: SP 的后端收到 ST 后，立即向 IdP 的 /serviceValidate 端点发起一个**安全的后台 HTTP/HTTPS 请求**，验证 ST 的有效性。
  5. **身份确认**: IdP 验证 ST 成功后，返回用户信息，并使 ST 失效。SP 创建本地会话。
- **优点**:
  - 
  - **高安全性**: 用户凭证不离开 IdP，票据一次性使用且在后端验证，对前端透明。
  - **架构清晰解耦**: 认证逻辑与业务逻辑完全分离，SP 职责单一。
- **缺点**:
  - 
  - **性能开销**: 每次登录新应用都需要一次额外的后端 HTTP 调用来验证票据。
  - **协议特定**: 主要用于支持 CAS 协议的系统，通用性不如 SAML/OIDC。
- **适用场景**:
  - 
  - **企业级内部应用、高校系统、政府项目**等对安全性、稳定性和架构清晰度有高要求的场景。特别是在已有 CAS 生态的环境中。

#### **3.2.2 子模式：断言消费 (Assertion Consumption)**

- 
- **关联协议**: **SAML 2.0 协议**。
- **工作原理**:
  1. 
  2. **发起认证请求**: SP 生成一个 XML 格式的认证请求(AuthnRequest)，通过浏览器重定向发送给 IdP。
  3. **生成断言**: 用户在 IdP 登录。IdP 创建一个包含用户身份信息的 XML 文档（**SAML Response**），并使用其**私钥**进行数字签名。
  4. **传递断言**: IdP 将包含 SAML Response 的表单自动提交回 SP 的**断言消费服务 (ACS) URL**。
  5. **验证断言**: SP 使用预先获取的 IdP **公钥**来验证 SAML Response 的数字签名。验证通过后，解析 XML 获取用户信息，创建本地会话。
- **优点**:
  - 
  - **功能强大**: 支持复杂的属性交换和联邦信任关系，是实现不同组织间 SSO 的利器。
  - **企业级标准**: 在 B2B 场景和大型企业集成（如微软 ADFS, Salesforce）中是首选。
- **缺点**:
  - 
  - **配置复杂**: XML 和元数据交换（Metadata Exchange）的配置非常繁琐，调试困难。
  - **体积庞大**: XML 格式相比 JSON 更重，不适合性能敏感或移动应用。
- **适用场景**:
  - 
  - **B2B 应用集成**：当你的应用需要作为服务卖给其他公司，并与对方公司的身份系统打通时。
  - **联邦认证**：在多个独立的组织之间建立信任关系，实现跨组织的 SSO。

------



### **3.3 模式三：基于令牌的无状态模式 (现代)**

这是当前最主流的模式，其核心是 IdP 颁发一个自包含的、可被 SP 在本地验证的令牌。

#### **典型代表：基于 JWT 的身份认证**

- 
- **关联协议**: **OpenID Connect (OIDC) 1.0**。
- **工作原理 (遵循 OIDC 的授权码流程)**:
  1. 
  2. **发起授权请求**: SP 将用户重定向到 IdP 的授权端点，请求 scope=openid 并提供 response_type=code。
  3. **返回授权码**: 用户在 IdP 登录并授权后，IdP 将浏览器重定向回 SP，并附带一个一次性的**授权码 (Code)**。
  4. **交换令牌**: SP 的**后端**使用此授权码，向 IdP 的令牌端点发起请求。
  5. **颁发令牌**: IdP 验证授权码后，返回 **ID Token (JWT)** 和 **Access Token**。
  6. **本地验证与会话创建**: SP **在本地**使用 IdP 的公钥验证 ID Token 的签名和内容。验证通过后，创建本地会话。
  7. **API 访问**: 客户端携带 Access Token 去访问受保护的 API。
- **优点**:
  - 
  - **完全无状态与高性能**: SP 可在本地验证令牌，无需额外网络请求，极利于微服务扩展。
  - **标准且灵活**: OIDC 流程清晰，同时支持 Web、移动端等多种客户端类型。
  - **轻量级**: 基于 JSON，对网络友好，易于解析。
  - **生态极其繁荣**: 几乎所有现代语言、框架和云服务都提供完善的支持。
- **缺点**:
  - 
  - **令牌吊销复杂**: JWT 的无状态性使得吊销成为一个挑战，通常需要引入黑名单等机制，这会增加系统的复杂性。
  - **流程相对复杂**: 相比简单的票据模式，OIDC 的流程涉及更多步骤，但现代库已将其封装得很好。
- **适用场景**:
  - 
  - **所有新项目**：无论是 Web 应用、前后端分离的 SPA、微服务后端，还是移动 App。
  - **构建开放平台**: 当你需要向第三方开发者提供 API 时，OIDC (OAuth 2.0) 是最佳选择。

------



### **4. 综合对比与终极选型指南**



















| 维度       | 共享存储模式 | CAS 模式       | SAML 模式         | OIDC (JWT) 模式          |
| ---------- | ------------ | -------------- | ----------------- | ------------------------ |
| 核心协议   | 无 (自定义)  | CAS            | SAML 2.0          | OIDC 1.0 (基于OAuth 2.0) |
| 数据格式   | 自定义       | 文本票据       | XML               | JSON (JWT)               |
| 服务状态   | 有状态       | SP无状态       | SP无状态          | 完全无状态               |
| 适用场景   | 已淘汰       | 企业内部、高校 | B2B集成、联邦认证 | Web/App、微服务 (首选)   |
| 实现复杂度 | 极低         | 中             | 高                | 中 (库封装后较低)        |
| 性能       | 差           | 中             | 差                | 高                       |
| 生态系统   | -            | 成熟但特定     | 广泛 (企业级)     | 极其繁荣 (全领域)        |

#### **如何做出最终选择？**

- 
- **构建全新的 Web/App 或微服务系统？**
  - 
  - **答案：OIDC**。这是毫无疑问的最佳选择。它现代化、轻量、无状态且生态系统极其强大。选择一个成熟的 IdP 实现（如 **Keycloak** 开源自建，或 **Auth0/Okta** 云服务）即可快速搭建。
- **需要与大型企业客户（如使用微软 AD）的系统集成？**
  - 
  - **答案：SAML 2.0**。准备好应对 SAML 的配置。你的系统作为 SP，需要与客户的 IdP 交换元数据并进行集成。
- **维护或扩展一个已有的、基于 CAS 的庞大系统？**
  - 
  - **答案：继续使用 CAS**。在现有生态中保持一致性通常比引入新协议成本更低。CAS 本身是一个非常稳定可靠的方案。
- **临时性的、内部的、简单的多应用登录需求？**
  - 
  - **答案：坚决避免共享存储模式**。即使是临时方案，也建议使用一个轻量级的 OIDC 实现。从长远来看，自定义方案的技术债是巨大的。

### **5. 总结**

单点登录（SSO）从早期的自定义技巧，发展到今天由 **OIDC、SAML、CAS** 三大协议主导的成熟领域。

- 
- **SAML** 是过去企业级市场的王者，稳重而强大，至今在联邦认证领域无可替代。
- **CAS** 在特定领域（如教育网）深耕多年，以其简洁安全的设计占有一席之地。
- **OIDC** 则是当今和未来的绝对主流，凭借其轻量、灵活、无状态的特性，完美契合了现代互联网应用的架构需求。

理解这些协议的本质和它们所对应的实现模式，将使您在进行技术选型和架构设计时，能够做出最明智、最符合长远利益的决策。