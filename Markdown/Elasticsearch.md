# 1、什么是 Elastisearch？

> 你懂的，用来搜索（也用来分析）

Elasticsearch 是位于 Elastic Stack 中心的分布式搜索和分析引擎。Logstach 和 Beats 促进采集、合计以及充实你的数据并在 Elasticsearch 中存储它们。Kibana 允许你去交互式的探索、可视化和共享对数据的见解，以及监视这个栈（Elastic Stack）。Elasticsearch 是索引、搜索和分析的神奇所在。

Elasticsearch 为各种数据类型提供接近实时的搜索和分析。不论你有结构化或非结构化的文本、数字数据，还是地理空间数据，Elasticsearch 能以支持快速搜索的方式高效地存储和索引它。你可以远超简单数据检索和聚合信息的方式去发现你数据中的趋势和模式。而且，随着你数据和查询量的增长，Elasticsearch 分布式的特性允许你的部署能随着它无缝地增长匹配。

虽然不是每个问题都是搜索问题，但 Elasticsearch 在大量实例中提供了处理数据的速度和灵活性：

- 为应用或者网站添加搜索框
- 存储和分析日志、度量和安全事件数据
- 使用机器学习，实时自动建模你的数据行为
- 使用 Elasticsearch 作为存储引擎来自动化业务工作流
- 使用 Elasticsearch 作为地理信息系统（GIS）管理、集成和分析空间信息，以及使用 Elasticsearch 作为生物学信息研究工具处理基因数据

我们一直对人们使用搜索的新奇方式感觉惊奇。但是不论你的实例与其中一个相似，还是你正使用 Elasticsearch 来解决一个新的问题，你在 Elasticsearch处理数据、文档和索引的方式是相同的。

<br>

## 1.1、数据输入：文档和索引

Elasticsearch 是一种分布式文档存储。Elasticsearch 不用列数据行存储信息，而是存储已序列化为 JSON 文档的复杂数据结构。当集群中有多个 Elasticsearch 节点时，存储的文档将分布在集群中，且可以从任何节点直接访问。

当一个文档被存储时，它会被索引并且在接近实时的 1 秒钟内被完全可搜索。Elasticsearch 使用一种称之为倒排索引的数据结构，支持非常快的全文搜索。倒排索引列出任何文档中出现的唯一单词，并标识每个单词出现的所有文档。

索引可被认作一种文档的优化集合，且每个文档都是字段的集合，字段是包含你数据的键值对。默认情况下，Elasticsearch 索引每个字段中的所有数据，且每个被索引的字段有一个专用的优化数据结构。例如，文本字段被存储在倒排索引中，数字和地理字段存储在 `BKD 树` 中。使用每个字段的数据结构来聚集和返回搜索结果是让 Elasticsearch 如此快的原因。

Elasticsearch 也具有无模式能力，这意味着文档无需明确地指定如何处理可能出现中文档中的每个不同的字段，就可以被索引。当启用动态映射后，Elasticsearch 自动检测和向索引中添加新的字段。这个默认行为使索引和浏览你的数据更容易——只需开始索引文档，Elasticsearch 会自动检测和映射布尔值、浮点值和整数值、日期以及字符串到合适的 Elasticsearch 数据类型。

最终，然而你比 Elasticsearch 更了解你的数据以及你想如何使用它们。你能定义控制动态映射规则，而且明确的定义映射以完全控制字段如何存储和索引。

定义你自己的映射使用你能够：

- 区分全文字符串字段和精确值字符串字段
- 执行特定语言的文本分析
- 为部分匹配优化字段
- 使用自定义的日期格式
- 使用无法自动检测的数据类型，如 `geo_point` 和 `geo_shape`

为不同的目的以不同的方式索引相同的字段，通常是有用的。例如，你可能想索引一个字符串字段，既作为全文搜索的文本字段，也作为用于排序和聚合你的数据的关键字段。或者，你可以选择使用多个语言分析器，用来处理包含用户输入的字符串字段的内容。

用于索引期间的全文字段的分析链，也被用于搜索时。当你查询一个全文字段时，在索引中查询词语（`term`）之前，这个查询文本将经历相同的分析。

<br>

## 1.2、信息输出：搜索和分析

虽然你能将 Elasticsearch 用作文档存储和检测文档及他们的元数据，但真正强大之处在于能轻松访问构建在 Apache Lucene 搜索引擎库之上的全套搜索能力。

Elasticsearch 提供一种简单、一致的 REST API，用于管理你的集群以及索引和搜索数据。用于测试目的，你可以轻松地从命令行或者在 Kibana 中通过开发者控制台提交请求。从你的应用里，你可以为你的语言选择 Elasticsearch 客户端：Java、JavaScript、GO、.Net、PHP、Perl、Python 或者 Ruby。

<br>

**搜索你的数据**

Elasticsearch REST API 支持结构化查询、全文查询以及结合二者的复杂查询。结构化查询类似于你在 SQL 中构造的查询类型。例如，你可以在职员索引中搜索性别和年龄字段，并按雇佣日期字段对匹配项进行排序。全文查询，查找查询字符串匹配的所有文档，且返回按相关性——他们与搜索词语匹配程度——排序的文档。

除了搜索单个词语，你也可以执行短语搜索、相似性搜索和前缀搜索，并且获得自动完成建议。

有你想搜索的地理空间或者其他数字数据吗？ Elasticsearch 在优化数据结构中索引非文本数据用于支持高性能地理和数字查询。

你可以访问使用 Elasticsearch 全部 JSON 风格的查询语言（查询 DSL）的所有搜索能力。你也可以构造 SQL 风格的查询搜索和聚合在 Elasticsearch 中的内部数据，JDBC 和 ODBC 驱动使得各种第三方应用能通过 SQL 与 Elasticsearch 交互。

<br>

**分析你的数据**

Elasticsearch 聚合使你能够构建数据的复杂摘要，并深入了解关键度量、模式和趋势。聚合使你能回答以下类似的问题，而不是仅仅找到众所周知的 “大海捞针”：

- 大海中有多少针？
- 针的平均长度是多少？
- 按制造商分类，针的平均长度是多少？
- 过去六个月，每个月加了多少针？

你也可以使用聚合去回答更多微妙的问题，比如：

- 你最受欢迎的针制造商是谁？
- 是否有特别或者异常的针束？

因为聚合借用了用于搜索的相同数据结构，所以他们也非常快。这使得你能实时分析和可视化数据。你的报告和仪表盘随着你的数据变化而更新，以便你可以基于最新的信息采取行动。

此外，聚合随着搜索请求一起运行。你可以搜索文档、过滤结果以及在单个请求中同时对同样的数据实时地执行分析。由于聚合是在特定搜索的上下文中计算的，你不仅能展示 70 号针的数量，你还能展示匹配你的用户搜索标准——比如不粘的绣花针——的 70 号针数量。

<br>

**但是等等，还有更多**

想自动分析时序数据吗？你可以使用机器学习特性去创建在你数据中的正常行为的准确基线，并识别异常模式。通过机器学习，你能发现：

- 与值、计数或者频率有关的时间偏差异常
- 统计稀有性
- 群体成员的异常行为

最好的部分呢？你可以这样做，而不必指定算法、模型或其他与科学相关的配置。

<br>

## 1.3、可伸缩性和弹性

**集群、节点和分片**

Elasticsearch 被构建为始终可用，并且能按需扩展。它是通过天然的分布式来实现的。你可以通过向集群添加服务器（节点）来增加容量，Elasticsearch 自动分布你的数据和查询到所有可用节点。无需改造你的应用，Elasticsearch 知道如何平衡多节点集群以提供规模和高可用性。节点越多越好。

这是如何工作的？实际来讲，一个 Elasticsearch 索引只是一个或多个物理分片的逻辑组，其中每个分片实际上是一个独立索引。通过将索引中的文档分布在多个分片上，并将这些分片分布在多个节点上，Elasticsearch 能确保冗余，这既能防止硬盘损坏也能在节点添加到集群时增加查询容量。随着集群的伸缩，Elasticsearch 自动迁移分片以重新平衡集群。

有两种类型的分片：主分片和副本。索引中的每个文档都属于一个主分片。一个副本分片是一个主分片的复制。副本提供了数据冗余复制，以防止硬件故障，并增加服务读取请求——如搜索或者检索文档——的容量。

索引中的主分片的数量是索引创建时固定的，但副本分片数量可以随时更改而不会中断索引或者查询操作。

<br>

**看具体情况……**

对于分片大小和索引主分片数量的配置，有许多性能的考虑和权衡。分片越多，仅维护这些索引的开销就越大。分片越大，在 Elasticsearch 需要重平衡集群时，移动分片的耗时越久。

查询大量的小分片，可以让每个分片的处理更快，但更多的查询也意味着开销，所以查询更少的大分片也可能更快。简而言之……这得看情况。

作为起点：

- 要保持平均分片大小在几 `GB` 到几十 `GB`。对于使用基于时间的数据用例，通常分片处于 `20 GB` 到 `40 GB` 的范围。
- 避免大量分片的问题。一个节点能容纳的分片数量与可用堆空间成比例。一般来讲，每 `GB` 堆空间的分片数量应少于 20。

确定你的用例的最优配置的最好方法，是 [`用你自己的数据和查询进行测试`](https://www.elastic.co/cn/elasticon/conf/2016/sf/quantitative-cluster-sizing)。

<br>

**容灾**

出于性能的原因，集群中的节点需要在同一网络中。在不同数据中心平衡集群中的分片会花很长时间。但高可用的架构要求你要避免把所有鸡蛋放到一个篮子里。在一个位置发生重大停机的情况下，另一个位置的服务器需要能够无缝的接管。答案是什么呢？跨集群复制（`CCR`）。

CCR 提供了一种方式自动地从主集群同步索引到作为热备的备份远程集群。如果主集群失效了，备份集群就会接管。你也可以使用 `CCR` 创建备份集群，以便在地理上靠近用户时，为读请求提供服务。

跨集群备份（`CCR`）是 `主动-被动模式`（`active-passive`）。主集群上的索引是活动的领导者索引，且处理所有写请求。复制到备份集群的索引是只读的追随者。

<br>

**维护保养**

与任何企业系统一样，你需要工具来保护、管理和监控你的 Elasticsearch 集群。集成到 Elasticsearch 中的安全、监控和管理特性使你能使用 Kibana 作为管理集群的控制中心。数据汇总和索引生命周期管理等特性可帮助你随着时间的推移智能地管理数据。

<br>

# 2、安装

## 2.1、Linux（Ubuntu）

1. 安装 ES 不用使用 root 用户，创建普通用户：

   ```shell
   # 添加用户 esuser，并指定 /home/esuser 为用户目录
   useradd -c es用户 –d /home/esuser -m esuser
   # 修改 esuser 用户密码
   passwd esuser
   # 切换 es 用户登录（并使用 es 用户的工作目录）
   su - esuser
   ```

2. 为你的操作系统下载 Elasticsearch 压缩包：

   ```shell
   curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.14.0-linux-x86_64.tar.gz
   ```

3. 解压文件：

   ```shell
   tar -xvf elasticsearch-7.14.0-linux-x86_64.tar.gz
   ```

4. 从 `bin` 目录中启动 Elasticsearch：

   ```shell
   cd elasticsearch-7.14.0/bin
   ./elasticsearch
   ```

   现在你就运行起了一个单节点 Elasticsearch 集群！

5. ES 启动默认监听 9200 端口，访问 9200：
   ```shell
   curl http://localhost:9200
   ```

   ![image-20220630111509343](../Images/Elasticsearch/image-20220630111509343.png)

<br>

**ES 目录结构：**

![image-20220630105257034](../Images/Elasticsearch/image-20220630105257034.png)

```shell
- bin	  启动ES服务脚本目录
- config  ES配置文件的目录
- data    ES的数据存放目录
- jdk     ES提供需要指定的jdk目录
- lib     ES依赖第三方库的目录
- logs    ES的日志目录
- modules 模块的目录
- plugins 插件目录
```

<br>

## 2.3、使用 cURL 命令交互

本指南中的大部分示例，允许你复制合适的 cURL 命令，并从命令行中向本地 Elasticsearch 实例提交请求。

对 Elasticsearch 的请求包含与任何 HTTP 请求相同的部分：

```shell
curl -X<VERB> '<PROTOCOL>://<HOST>:<PORT>/<PATH>?<QUERY_STRING>' -d '<BODY>'
```

这个示例使用以下变量：

- `<VERB>` - 合适的 HTTP 方法或操作。例如，`GET`、`POST`、`PUT`、`HEAD` 或 `DELETE`。
- `<PROTOCOL>` - `http` 或 `https`。如果你在 Elasticsearch 之前有 HTTPS 代理，或者你使用的 Elasticsearch 安全特性去加密 HTTP 通信，使用后者。
- `<HOST>` - Elasticsearch 集群的任意节点主机名。或者对本地机器上的节点使用 `localhost`。
- `<PORT>` - 运行 Elasticsearch HTTP 服务的端口，默认为 `9200`。
- `<PATH>` - API 路径，可以包含多部分，比如 `_cluster/stats` 或 `_nodes/stats/jvm`。
- `<QUERY_STRING>` - 一些可选的查询字符串参数。比如，`?pretty` 将打印 JSON 响应以使其更易阅读。
- `<BODY>` - JSON 编码的请求体（如果必须）。

如果启用了 Elasticsearch 安全特性，你必须提供用于认证运行 API 的有效用户名（以及密码）。例如，使用 `-u` 或 `--u` 的 cURL 命令参数。

Elasticsearch 对每个 API 请求响应 HTTP 状态码，如 `200 ok`。除了 `HEAD` 请求外，它还会返回一个 JSON 编码的响应体。