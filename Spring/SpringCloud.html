<!DOCTYPE html><html lang="zh" class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="canonical" href="https://0richalcos.github.io/Note/Spring/SpringCloud.html"><link rel="prev" href="SpringBoot.html"><link rel="next" href="SpringMVC.html"><link rel="icon" href="../assets/images/favicon.png"><meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>SpringCloud - 随便记记</title><link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css"><link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel="stylesheet" href="../_stylesheets/extra.css"><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head> <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal"> <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off"> <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off"> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a href="#1微服务" class="md-skip"> 跳转至 </a> </div> <div data-md-component="announce"> </div> <header class="md-header md-header--shadow" data-md-component="header"> <nav class="md-header__inner md-grid" aria-label="页眉"> <a href="../index.html" title="随便记记" class="md-header__button md-logo" aria-label="随便记记" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> <label class="md-header__button md-icon" for="__drawer"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> 随便记记 </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> SpringCloud </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input class="md-option" data-md-color-media data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal" aria-label="切换到深色模式" type="radio" name="__palette" id="__palette_0"> <label class="md-header__button md-icon" title="切换到深色模式" for="__palette_1" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> <input class="md-option" data-md-color-media data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal" aria-label="切换到亮色模式" type="radio" name="__palette" id="__palette_1"> <label class="md-header__button md-icon" title="切换到亮色模式" for="__palette_0" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <div class="md-header__source"> <a href="https://github.com/0richalcos/Note" title="前往仓库" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class="md-source__repository"> GitHub </div> </a> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a href="../index.html" title="随便记记" class="md-nav__button md-logo" aria-label="随便记记" data-md-component="logo"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg> </a> 随便记记 </label> <div class="md-nav__source"> <a href="https://github.com/0richalcos/Note" title="前往仓库" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg> </div> <div class="md-source__repository"> GitHub </div> </a> </div> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../index.html" class="md-nav__link"> <span class="md-ellipsis"> 🏠 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2"> <div class="md-nav__link md-nav__container"> <a href="../Java/Java.html" class="md-nav__link "> <span class="md-ellipsis"> ♨️ Java </span> </a> <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_2"> <span class="md-nav__icon md-icon"></span> ♨️ Java </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../Java/Java8.html" class="md-nav__link"> <span class="md-ellipsis"> Java 8 </span> </a> </li> <li class="md-nav__item"> <a href="../Java/JavaBasics.html" class="md-nav__link"> <span class="md-ellipsis"> Java 基础 </span> </a> </li> <li class="md-nav__item"> <a href="../Java/JavaCollection.html" class="md-nav__link"> <span class="md-ellipsis"> Java 集合 </span> </a> </li> <li class="md-nav__item"> <a href="../Java/JavaObject.html" class="md-nav__link"> <span class="md-ellipsis"> Java 类和对象 </span> </a> </li> <li class="md-nav__item"> <a href="../Java/JavaWeb.html" class="md-nav__link"> <span class="md-ellipsis"> JavaWeb </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3"> <div class="md-nav__link md-nav__container"> <a href="../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E7%AE%97%E6%B3%95/Algorithm.html" class="md-nav__link "> <span class="md-ellipsis"> 🧮 数据结构及算法 </span> </a> <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> 🧮 数据结构及算法 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%8F%8A%E7%AE%97%E6%B3%95/DesignPattern.html" class="md-nav__link"> <span class="md-ellipsis"> DesignPattern </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked> <div class="md-nav__link md-nav__container"> <a href="Spring.html" class="md-nav__link "> <span class="md-ellipsis"> 🍃 Spring </span> </a> <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> 🍃 Spring </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="SpringBoot.html" class="md-nav__link"> <span class="md-ellipsis"> SpringBoot </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc"> <label class="md-nav__link md-nav__link--active" for="__toc"> <span class="md-ellipsis"> SpringCloud </span> <span class="md-nav__icon md-icon"></span> </label> <a href="SpringCloud.html" class="md-nav__link md-nav__link--active"> <span class="md-ellipsis"> SpringCloud </span> </a> <nav class="md-nav md-nav--secondary" aria-label="目录"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#1微服务" class="md-nav__link"> <span class="md-ellipsis"> 1、微服务 </span> </a> <nav class="md-nav" aria-label="1、微服务"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#11单体应用和微服务结构应用" class="md-nav__link"> <span class="md-ellipsis"> 1.1、单体应用和微服务结构应用 </span> </a> </li> <li class="md-nav__item"> <a href="#12架构的演变" class="md-nav__link"> <span class="md-ellipsis"> 1.2、架构的演变 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#2springcloud" class="md-nav__link"> <span class="md-ellipsis"> 2、SpringCloud </span> </a> <nav class="md-nav" aria-label="2、SpringCloud"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#21核心组件说明" class="md-nav__link"> <span class="md-ellipsis"> 2.1、核心组件说明 </span> </a> </li> <li class="md-nav__item"> <a href="#22命名和版本选择" class="md-nav__link"> <span class="md-ellipsis"> 2.2、命名和版本选择 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#2环境搭建" class="md-nav__link"> <span class="md-ellipsis"> 2、环境搭建 </span> </a> </li> <li class="md-nav__item"> <a href="#3服务注册中心" class="md-nav__link"> <span class="md-ellipsis"> 3、服务注册中心 </span> </a> <nav class="md-nav" aria-label="3、服务注册中心"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#31eureka" class="md-nav__link"> <span class="md-ellipsis"> 3.1、Eureka </span> </a> <nav class="md-nav" aria-label="3.1、Eureka"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#311开发-eureka-server" class="md-nav__link"> <span class="md-ellipsis"> 3.1.1、开发 Eureka Server </span> </a> </li> <li class="md-nav__item"> <a href="#312开发-eureka-client" class="md-nav__link"> <span class="md-ellipsis"> 3.1.2、开发 Eureka Client </span> </a> </li> <li class="md-nav__item"> <a href="#313eureka-server-集群" class="md-nav__link"> <span class="md-ellipsis"> 3.1.3、Eureka Server 集群 </span> </a> </li> <li class="md-nav__item"> <a href="#314eureka-自我保护机制" class="md-nav__link"> <span class="md-ellipsis"> 3.1.4、Eureka 自我保护机制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#32consul" class="md-nav__link"> <span class="md-ellipsis"> 3.2、Consul </span> </a> <nav class="md-nav" aria-label="3.2、Consul"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#321安装-consul" class="md-nav__link"> <span class="md-ellipsis"> 3.2.1、安装 Consul </span> </a> </li> <li class="md-nav__item"> <a href="#322开发-consul-client" class="md-nav__link"> <span class="md-ellipsis"> 3.2.2、开发 Consul Client </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#4服务调用组件" class="md-nav__link"> <span class="md-ellipsis"> 4、服务调用组件 </span> </a> <nav class="md-nav" aria-label="4、服务调用组件"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#41resttemplate" class="md-nav__link"> <span class="md-ellipsis"> 4.1、RestTemplate </span> </a> </li> <li class="md-nav__item"> <a href="#42openfeign" class="md-nav__link"> <span class="md-ellipsis"> 4.2、OpenFeign </span> </a> <nav class="md-nav" aria-label="4.2、OpenFeign"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#421openfeign-服务调用" class="md-nav__link"> <span class="md-ellipsis"> 4.2.1、OpenFeign 服务调用 </span> </a> </li> <li class="md-nav__item"> <a href="#422调用服务并传参" class="md-nav__link"> <span class="md-ellipsis"> 4.2.2、调用服务并传参 </span> </a> </li> <li class="md-nav__item"> <a href="#423openfeign-超时设置" class="md-nav__link"> <span class="md-ellipsis"> 4.2.3、OpenFeign 超时设置 </span> </a> </li> <li class="md-nav__item"> <a href="#424日志展示" class="md-nav__link"> <span class="md-ellipsis"> 4.2.4、日志展示 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#5服务负载均衡" class="md-nav__link"> <span class="md-ellipsis"> 5、服务负载均衡 </span> </a> <nav class="md-nav" aria-label="5、服务负载均衡"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#51ribbon" class="md-nav__link"> <span class="md-ellipsis"> 5.1、Ribbon </span> </a> <nav class="md-nav" aria-label="5.1、Ribbon"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#511ribbon-服务调用" class="md-nav__link"> <span class="md-ellipsis"> 5.1.1、Ribbon 服务调用 </span> </a> </li> <li class="md-nav__item"> <a href="#512ribbon-的负载均衡策略" class="md-nav__link"> <span class="md-ellipsis"> 5.1.2、Ribbon 的负载均衡策略 </span> </a> </li> <li class="md-nav__item"> <a href="#513修改默认负载均衡策略" class="md-nav__link"> <span class="md-ellipsis"> 5.1.3、修改默认负载均衡策略 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#6服务断路器" class="md-nav__link"> <span class="md-ellipsis"> 6、服务断路器 </span> </a> <nav class="md-nav" aria-label="6、服务断路器"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#61hystrix" class="md-nav__link"> <span class="md-ellipsis"> 6.1、Hystrix </span> </a> <nav class="md-nav" aria-label="6.1、Hystrix"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#611服务雪崩熔断降级" class="md-nav__link"> <span class="md-ellipsis"> 6.1.1、服务雪崩、熔断、降级 </span> </a> </li> <li class="md-nav__item"> <a href="#622服务熔断的实现" class="md-nav__link"> <span class="md-ellipsis"> 6.2.2、服务熔断的实现 </span> </a> </li> <li class="md-nav__item"> <a href="#623服务降级的实现" class="md-nav__link"> <span class="md-ellipsis"> 6.2.3、服务降级的实现 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#7服务网关组件" class="md-nav__link"> <span class="md-ellipsis"> 7、服务网关组件 </span> </a> <nav class="md-nav" aria-label="7、服务网关组件"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#71gateway" class="md-nav__link"> <span class="md-ellipsis"> 7.1、Gateway </span> </a> <nav class="md-nav" aria-label="7.1、Gateway"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#711开发网关动态路由" class="md-nav__link"> <span class="md-ellipsis"> 7.1.1、开发网关动态路由 </span> </a> </li> <li class="md-nav__item"> <a href="#712查看网关路由规则" class="md-nav__link"> <span class="md-ellipsis"> 7.1.2、查看网关路由规则 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="SpringMVC.html" class="md-nav__link"> <span class="md-ellipsis"> SpringMVC </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5"> <div class="md-nav__link md-nav__container"> <a href="../%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6/MyBatis-Plus.html" class="md-nav__link "> <span class="md-ellipsis"> 💾 持久层框架 </span> </a> <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_5"> <span class="md-nav__icon md-icon"></span> 💾 持久层框架 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E6%8C%81%E4%B9%85%E5%B1%82%E6%A1%86%E6%9E%B6/Mybatis.html" class="md-nav__link"> <span class="md-ellipsis"> Mybatis </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6"> <div class="md-nav__link md-nav__container"> <a href="../%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83/SSO.html" class="md-nav__link "> <span class="md-ellipsis"> 🔐 认证与授权 </span> </a> <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_6"> <span class="md-nav__icon md-icon"></span> 🔐 认证与授权 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83/Sa-Token.html" class="md-nav__link"> <span class="md-ellipsis"> Sa-Token </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83/Shiro.html" class="md-nav__link"> <span class="md-ellipsis"> Shiro </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7"> <div class="md-nav__link md-nav__container"> <a href="../%E5%89%8D%E7%AB%AF/CSS.html" class="md-nav__link "> <span class="md-ellipsis"> 🌐 前端 </span> </a> <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_7"> <span class="md-nav__icon md-icon"></span> 🌐 前端 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/JavaScript.html" class="md-nav__link"> <span class="md-ellipsis"> JavaScript </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/Vue.html" class="md-nav__link"> <span class="md-ellipsis"> Vue </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/jQuery.html" class="md-nav__link"> <span class="md-ellipsis"> jQuery </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E/Thymeleaf.html" class="md-nav__link"> <span class="md-ellipsis"> Thymeleaf </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_5"> <div class="md-nav__link md-nav__container"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/AntV-X6.html" class="md-nav__link "> <span class="md-ellipsis"> 组件库 </span> </a> <label class="md-nav__link " for="__nav_7_5" id="__nav_7_5_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_5_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_7_5"> <span class="md-nav__icon md-icon"></span> 组件库 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/ApacheECharts.html" class="md-nav__link"> <span class="md-ellipsis"> ApacheECharts </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/Axios.html" class="md-nav__link"> <span class="md-ellipsis"> Axios </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/BootstrapTable.html" class="md-nav__link"> <span class="md-ellipsis"> BootstrapTable </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/DHTMLXGantt.html" class="md-nav__link"> <span class="md-ellipsis"> DHTMLXGantt </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/Element.html" class="md-nav__link"> <span class="md-ellipsis"> Element </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/FullCalendar.html" class="md-nav__link"> <span class="md-ellipsis"> FullCalendar </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%89%8D%E7%AB%AF/%E7%BB%84%E4%BB%B6%E5%BA%93/X-editable.html" class="md-nav__link"> <span class="md-ellipsis"> X-editable </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8"> <div class="md-nav__link md-nav__container"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/Dameng.html" class="md-nav__link "> <span class="md-ellipsis"> 📊 数据库 </span> </a> <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_8"> <span class="md-nav__icon md-icon"></span> 📊 数据库 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL.html" class="md-nav__link"> <span class="md-ellipsis"> MySQL </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/MySQLQuery.html" class="md-nav__link"> <span class="md-ellipsis"> MySQLQuery </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/OceanBase.html" class="md-nav__link"> <span class="md-ellipsis"> OceanBase </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/Oracle.html" class="md-nav__link"> <span class="md-ellipsis"> Oracle </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html" class="md-nav__link"> <span class="md-ellipsis"> Redis </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%95%B0%E6%8D%AE%E5%BA%93/Vastbase.html" class="md-nav__link"> <span class="md-ellipsis"> Vastbase </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/Elasticsearch.html" class="md-nav__link"> <span class="md-ellipsis"> Elasticsearch </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10"> <div class="md-nav__link md-nav__container"> <a href="../%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/FastDFS.html" class="md-nav__link "> <span class="md-ellipsis"> 📇 分布式存储 </span> </a> <label class="md-nav__link " for="__nav_10" id="__nav_10_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_10"> <span class="md-nav__icon md-icon"></span> 📇 分布式存储 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/MinIO.html" class="md-nav__link"> <span class="md-ellipsis"> MinIO </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11"> <div class="md-nav__link md-nav__container"> <a href="../%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/Encryption.html" class="md-nav__link "> <span class="md-ellipsis"> 🛰️ 网络通信 </span> </a> <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_11"> <span class="md-nav__icon md-icon"></span> 🛰️ 网络通信 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/HTTP.html" class="md-nav__link"> <span class="md-ellipsis"> HTTP </span> </a> </li> <li class="md-nav__item"> <a href="../%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/OpenVPN.html" class="md-nav__link"> <span class="md-ellipsis"> OpenVPN </span> </a> </li> <li class="md-nav__item"> <a href="../%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/VNC.html" class="md-nav__link"> <span class="md-ellipsis"> VNC </span> </a> </li> <li class="md-nav__item"> <a href="../%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/WebSocket.html" class="md-nav__link"> <span class="md-ellipsis"> WebSocket </span> </a> </li> <li class="md-nav__item"> <a href="../%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/frp.html" class="md-nav__link"> <span class="md-ellipsis"> frp </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12"> <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0"> <span class="md-ellipsis"> 🗃️ 文件处理 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_12"> <span class="md-nav__icon md-icon"></span> 🗃️ 文件处理 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12_1"> <div class="md-nav__link md-nav__container"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/Office/ApachePOI.html" class="md-nav__link "> <span class="md-ellipsis"> Office </span> </a> <label class="md-nav__link " for="__nav_12_1" id="__nav_12_1_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_1_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_12_1"> <span class="md-nav__icon md-icon"></span> Office </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/Office/EasyExcel.html" class="md-nav__link"> <span class="md-ellipsis"> EasyExcel </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/Office/OnlyOffice.html" class="md-nav__link"> <span class="md-ellipsis"> OnlyOffice </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/Office/Poi-tl.html" class="md-nav__link"> <span class="md-ellipsis"> Poi-tl </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/Office/Spire.OfficeForJava.html" class="md-nav__link"> <span class="md-ellipsis"> Spire.OfficeForJava </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/PDF/ApachePDFBox.html" class="md-nav__link"> <span class="md-ellipsis"> ApachePDFBox </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/XML/XMLParse.html" class="md-nav__link"> <span class="md-ellipsis"> XMLParse </span> </a> </li> <li class="md-nav__item"> <a href="../%E6%96%87%E4%BB%B6%E5%A4%84%E7%90%86/ZIP/Zip4j.html" class="md-nav__link"> <span class="md-ellipsis"> Zip4j </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="../%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/XXL-JOB.html" class="md-nav__link"> <span class="md-ellipsis"> XXL-JOB </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14"> <div class="md-nav__link md-nav__container"> <a href="../%E8%BF%90%E7%BB%B4/Docker.html" class="md-nav__link "> <span class="md-ellipsis"> 🧑‍🔧 运维 </span> </a> <label class="md-nav__link " for="__nav_14" id="__nav_14_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_14"> <span class="md-nav__icon md-icon"></span> 🧑‍🔧 运维 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/Linux.html" class="md-nav__link"> <span class="md-ellipsis"> Linux </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/NSSM.html" class="md-nav__link"> <span class="md-ellipsis"> NSSM </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/Nginx.html" class="md-nav__link"> <span class="md-ellipsis"> Nginx </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/Tomcat.html" class="md-nav__link"> <span class="md-ellipsis"> Tomcat </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/TongWeb.html" class="md-nav__link"> <span class="md-ellipsis"> TongWeb </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/WSL.html" class="md-nav__link"> <span class="md-ellipsis"> WSL </span> </a> </li> <li class="md-nav__item"> <a href="../%E8%BF%90%E7%BB%B4/WebLogic.html" class="md-nav__link"> <span class="md-ellipsis"> WebLogic </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15"> <div class="md-nav__link md-nav__container"> <a href="../%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Git.html" class="md-nav__link "> <span class="md-ellipsis"> 🛠️ 开发工具 </span> </a> <label class="md-nav__link " for="__nav_15" id="__nav_15_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_15"> <span class="md-nav__icon md-icon"></span> 🛠️ 开发工具 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Maven.html" class="md-nav__link"> <span class="md-ellipsis"> Maven </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Node.js.html" class="md-nav__link"> <span class="md-ellipsis"> Node.js </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/Swagger.html" class="md-nav__link"> <span class="md-ellipsis"> Swagger </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16"> <div class="md-nav__link md-nav__container"> <a href="../%E5%85%B6%E4%BB%96/Settings.html" class="md-nav__link "> <span class="md-ellipsis"> 👻 其他 </span> </a> <label class="md-nav__link " for="__nav_16" id="__nav_16_label" tabindex="0"> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false"> <label class="md-nav__title" for="__nav_16"> <span class="md-nav__icon md-icon"></span> 👻 其他 </label> <ul class="md-nav__list" data-md-scrollfix> <li class="md-nav__item"> <a href="../%E5%85%B6%E4%BB%96/Solutions.html" class="md-nav__link"> <span class="md-ellipsis"> Solutions </span> </a> </li> <li class="md-nav__item"> <a href="../%E5%85%B6%E4%BB%96/Weasel.html" class="md-nav__link"> <span class="md-ellipsis"> Weasel </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav class="md-nav md-nav--secondary" aria-label="目录"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix> <li class="md-nav__item"> <a href="#1微服务" class="md-nav__link"> <span class="md-ellipsis"> 1、微服务 </span> </a> <nav class="md-nav" aria-label="1、微服务"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#11单体应用和微服务结构应用" class="md-nav__link"> <span class="md-ellipsis"> 1.1、单体应用和微服务结构应用 </span> </a> </li> <li class="md-nav__item"> <a href="#12架构的演变" class="md-nav__link"> <span class="md-ellipsis"> 1.2、架构的演变 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#2springcloud" class="md-nav__link"> <span class="md-ellipsis"> 2、SpringCloud </span> </a> <nav class="md-nav" aria-label="2、SpringCloud"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#21核心组件说明" class="md-nav__link"> <span class="md-ellipsis"> 2.1、核心组件说明 </span> </a> </li> <li class="md-nav__item"> <a href="#22命名和版本选择" class="md-nav__link"> <span class="md-ellipsis"> 2.2、命名和版本选择 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#2环境搭建" class="md-nav__link"> <span class="md-ellipsis"> 2、环境搭建 </span> </a> </li> <li class="md-nav__item"> <a href="#3服务注册中心" class="md-nav__link"> <span class="md-ellipsis"> 3、服务注册中心 </span> </a> <nav class="md-nav" aria-label="3、服务注册中心"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#31eureka" class="md-nav__link"> <span class="md-ellipsis"> 3.1、Eureka </span> </a> <nav class="md-nav" aria-label="3.1、Eureka"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#311开发-eureka-server" class="md-nav__link"> <span class="md-ellipsis"> 3.1.1、开发 Eureka Server </span> </a> </li> <li class="md-nav__item"> <a href="#312开发-eureka-client" class="md-nav__link"> <span class="md-ellipsis"> 3.1.2、开发 Eureka Client </span> </a> </li> <li class="md-nav__item"> <a href="#313eureka-server-集群" class="md-nav__link"> <span class="md-ellipsis"> 3.1.3、Eureka Server 集群 </span> </a> </li> <li class="md-nav__item"> <a href="#314eureka-自我保护机制" class="md-nav__link"> <span class="md-ellipsis"> 3.1.4、Eureka 自我保护机制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#32consul" class="md-nav__link"> <span class="md-ellipsis"> 3.2、Consul </span> </a> <nav class="md-nav" aria-label="3.2、Consul"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#321安装-consul" class="md-nav__link"> <span class="md-ellipsis"> 3.2.1、安装 Consul </span> </a> </li> <li class="md-nav__item"> <a href="#322开发-consul-client" class="md-nav__link"> <span class="md-ellipsis"> 3.2.2、开发 Consul Client </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#4服务调用组件" class="md-nav__link"> <span class="md-ellipsis"> 4、服务调用组件 </span> </a> <nav class="md-nav" aria-label="4、服务调用组件"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#41resttemplate" class="md-nav__link"> <span class="md-ellipsis"> 4.1、RestTemplate </span> </a> </li> <li class="md-nav__item"> <a href="#42openfeign" class="md-nav__link"> <span class="md-ellipsis"> 4.2、OpenFeign </span> </a> <nav class="md-nav" aria-label="4.2、OpenFeign"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#421openfeign-服务调用" class="md-nav__link"> <span class="md-ellipsis"> 4.2.1、OpenFeign 服务调用 </span> </a> </li> <li class="md-nav__item"> <a href="#422调用服务并传参" class="md-nav__link"> <span class="md-ellipsis"> 4.2.2、调用服务并传参 </span> </a> </li> <li class="md-nav__item"> <a href="#423openfeign-超时设置" class="md-nav__link"> <span class="md-ellipsis"> 4.2.3、OpenFeign 超时设置 </span> </a> </li> <li class="md-nav__item"> <a href="#424日志展示" class="md-nav__link"> <span class="md-ellipsis"> 4.2.4、日志展示 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#5服务负载均衡" class="md-nav__link"> <span class="md-ellipsis"> 5、服务负载均衡 </span> </a> <nav class="md-nav" aria-label="5、服务负载均衡"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#51ribbon" class="md-nav__link"> <span class="md-ellipsis"> 5.1、Ribbon </span> </a> <nav class="md-nav" aria-label="5.1、Ribbon"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#511ribbon-服务调用" class="md-nav__link"> <span class="md-ellipsis"> 5.1.1、Ribbon 服务调用 </span> </a> </li> <li class="md-nav__item"> <a href="#512ribbon-的负载均衡策略" class="md-nav__link"> <span class="md-ellipsis"> 5.1.2、Ribbon 的负载均衡策略 </span> </a> </li> <li class="md-nav__item"> <a href="#513修改默认负载均衡策略" class="md-nav__link"> <span class="md-ellipsis"> 5.1.3、修改默认负载均衡策略 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#6服务断路器" class="md-nav__link"> <span class="md-ellipsis"> 6、服务断路器 </span> </a> <nav class="md-nav" aria-label="6、服务断路器"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#61hystrix" class="md-nav__link"> <span class="md-ellipsis"> 6.1、Hystrix </span> </a> <nav class="md-nav" aria-label="6.1、Hystrix"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#611服务雪崩熔断降级" class="md-nav__link"> <span class="md-ellipsis"> 6.1.1、服务雪崩、熔断、降级 </span> </a> </li> <li class="md-nav__item"> <a href="#622服务熔断的实现" class="md-nav__link"> <span class="md-ellipsis"> 6.2.2、服务熔断的实现 </span> </a> </li> <li class="md-nav__item"> <a href="#623服务降级的实现" class="md-nav__link"> <span class="md-ellipsis"> 6.2.3、服务降级的实现 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item"> <a href="#7服务网关组件" class="md-nav__link"> <span class="md-ellipsis"> 7、服务网关组件 </span> </a> <nav class="md-nav" aria-label="7、服务网关组件"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#71gateway" class="md-nav__link"> <span class="md-ellipsis"> 7.1、Gateway </span> </a> <nav class="md-nav" aria-label="7.1、Gateway"> <ul class="md-nav__list"> <li class="md-nav__item"> <a href="#711开发网关动态路由" class="md-nav__link"> <span class="md-ellipsis"> 7.1.1、开发网关动态路由 </span> </a> </li> <li class="md-nav__item"> <a href="#712查看网关路由规则" class="md-nav__link"> <span class="md-ellipsis"> 7.1.2、查看网关路由规则 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <nav class="md-path" aria-label="导航栏"> <ol class="md-path__list"> <li class="md-path__item"> <a href="../index.html" class="md-path__link"> <span class="md-ellipsis"> 🏠 首页 </span> </a> </li> <li class="md-path__item"> <a href="SpringBoot.html" class="md-path__link"> <span class="md-ellipsis"> 🍃 Spring </span> </a> </li> </ol> </nav> <article class="md-content__inner md-typeset"> <h1 id="springcloud">SpringCloud<a class="headerlink" href="#springcloud" title="锚点链接">¶</a></h1> <h2 id="1微服务">1、微服务<a class="headerlink" href="#1微服务" title="锚点链接">¶</a></h2> <p>微服务就是由一系列围绕自己业务开发的微小服务构成，他们独立部署运行在自己的进程里，基于分布式进行管理。</p> <p>微服务是一种架构，这种架构是将单个的整体应用程序分割成更小的项目关联的独立的服务。一个服务通常实现一组独立的特性或功能，包含自己的业务逻辑和适配器。各个微服务之间的关联通过暴露 API 来实现。这些独立的微服务不需要部署在同一个虚拟机、同一个系统和同一个应用服务器中。</p> <h3 id="11单体应用和微服务结构应用">1.1、单体应用和微服务结构应用<a class="headerlink" href="#11单体应用和微服务结构应用" title="锚点链接">¶</a></h3> <p><strong>单体应用</strong></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20200708224716035.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20200708224716035.png" alt="image-20200708224716035" style></a></p> <p>优点：</p> <ul> <li>单一架构模式在项目初期很小的时候开发方便，测试方便，部署方便，运行良好</li> </ul> <p>缺点：</p> <ul> <li>应用随着时间的推进，加入的功能越来越多，最终会变得巨大，一个项目中很有可能数百万行的代码，互相之间繁琐的 jar 包</li> <li>久而久之，开发效率低，代码维护困难</li> <li>如果想整体应用采用新的技术、新的框架或者语言会很困难</li> <li>任意模块的漏洞或者错误都会影响整个应用，降低系统的可靠性</li> </ul> <p><strong>微服务结构应用</strong></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20200723155352063.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20200723155352063.png" alt="image-20200723155352063" style></a></p> <p>优点：</p> <ul> <li>将服务拆分成多个单一职责的小的服务，进行单独部署，服务之间通过网络进行通信</li> <li>每个服务应该有自己单独的管理团队，高度自治</li> <li>服务各自有自己单独的职责，服务之间松耦合，避免因一个模块的问题导致服务崩溃</li> </ul> <p>缺点：</p> <ul> <li>开发人员要处理分布式系统的复杂性</li> <li>多服务运维难度，随着服务的增加，运维的压力也在增大</li> <li>服务治理 和 服务监控 关键</li> </ul> <h3 id="12架构的演变">1.2、架构的演变<a class="headerlink" href="#12架构的演变" title="锚点链接">¶</a></h3> <p><code>[单一应用架构]</code>==&gt; <code>[垂直应用架构]</code> ==&gt; <code>[分布式服务架构]</code> ==&gt;<code>[流动计算架构]||[微服务架构]</code> </p> <p><strong>All in One Application 单一架构</strong></p> <p>起初当网站流量很小时，将所有功能都写在一个应用里面，对整个应用进行部署，以减少部署节点和成本。对于这个架构简化增删改查的工作量的数据访问框架（ORM）是关键。</p> <p><strong>Vertical Application 垂直架构</strong></p> <p>当访问量逐渐增大，单一应用增加机器带来的加速度越来越小，提升效率的方法之一是将应用拆成互不相干的几个应用，以提升效率。此时，用于加速前端页面开发的Web框架（MVC）是关键。</p> <p><strong>Distributed Service 分布式服务架构</strong></p> <p>当垂直应用越来越多，应用之间交互不可避免，将核心业务抽取出来，作为独立的服务，逐渐形成稳定的服务中心，使前端应用能更快速的响应多变的市场需求。此时，用于提高业务复用及整合的分布式服务框架（RPC）是关键。</p> <p><strong>Elastic Computing 流动计算架构即微服务架构</strong></p> <p>当服务越来越多，容量的评估，小服务资源的浪费等问题逐渐显现，此时需增加一个调度中心基于访问压力实时管理集群容量，提高集群利用率。此时，用于提高机器利用率的资源调度和治理中心（SOA）是关键。</p> <h2 id="2springcloud">2、SpringCloud<a class="headerlink" href="#2springcloud" title="锚点链接">¶</a></h2> <p>SpringCloud 为开发人员提供了在分布式系统中快速构建一些通用模式的工具，例如配置管理、服务发现、断路器、智能路由、微代理、控制总线。分布式系统的协调导致了锅炉板模式，开发人员使用 SpringCloud 可以快速地建立实现这些模式的服务和应用程序。</p> <p>通俗理解：SpringCloud 是一个含概多个子项目的开发工具集，集合了众多的开源框架，它利用了 SpringBoot 开发的便利性实现了很多功能，如服务注册、服务注册发现、负载均衡等。SpringCloud 在整合过程中主要是针对 Netflix 开源组件的封装。SpringCloud 的出现真正的简化了分布式架构的开发。</p> <blockquote> <p>NetFlix 是美国的一个在线视频网站、微服务业的翘楚，它是公认的大规模生产级微服务的杰出实践者，NetFlix 的开源组件已经在它大规模分布式微服务环境中经过多年的生产实战验证，因此 SpringCloud 中很多组件都是基于NetFlix。</p> </blockquote> <h3 id="21核心组件说明">2.1、核心组件说明<a class="headerlink" href="#21核心组件说明" title="锚点链接">¶</a></h3> <ul> <li>EurekaServer、Consul、Nacos 服务注册中心组件</li> <li>Rabbion &amp; OpenFeign 服务负载均衡 和 服务调用组件</li> <li>Hystrix &amp; Hystrix Dashboard 服务断路器 和 服务监控组件</li> <li>Zuul、Gateway 服务网关组件</li> <li>Config 统一配置中心组件</li> <li>Bus 消息总线组件</li> <li>...</li> </ul> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20200724161314786.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20200724161314786.png" alt="image-20200724161314786" style></a></p> <h3 id="22命名和版本选择">2.2、命名和版本选择<a class="headerlink" href="#22命名和版本选择" title="锚点链接">¶</a></h3> <p><strong>SpringCloud 的命名</strong></p> <p>SpringCloud 是一个由众多独立子项目组成的大型综合项目，原则每个子项目上有不同的发布节奏，都维护自己发布版本号。为了更好的管理SpringCloud 的版本，通过一个资源清单BOM(Bill of Materials)，为避免与子项目的发布号混淆，所以没有采用版本号的方式，而是通过命名的方式。</p> <p>这些名字是按字母顺序排列的，如伦敦地铁站的名称（“天使” 是第一个版本，“布里斯顿” 是第二个版本，”卡姆登“ 是第三个版本）。当单个项目的点发布累积到一个临界量，或者其中一个项目中有一个关键缺陷需要每个人都可以使用时，发布序列将推出名称以 “.SRX” 结尾的 “服务发布”，其中 “X” 是一个数字。</p> <p><strong>SpringCloud 的版本选择</strong></p> <ul> <li>Angel 版本基于 SpringBoot1.2.x 版本构建与 1.3 版本不兼容</li> <li>Brixton 版本基于 SpringBoot1.3.x 版本构建与 1.2 版本不兼容 2017 年 Brixton and Angel release 官方宣布报废</li> <li>Camden 版本基于 SpringBoot1.4.x 版本构建并在 1.5 版本通过测试 2018 年 Camden release 官方宣布报废</li> <li>Dalston、Edgware 版本基于 SpringBoot1.5.x 版本构建，目前不能在 SpringBoot2.0.x 版本中使用 Dalston（达尔斯顿）将于 2018 年 12 月官方宣布报废 Edgware 将遵循 Spring Boot 1.5.x 的生命周期结束</li> <li>Finchley 版本基于 SpringBoot2.0.x 版本进行构建，不能兼容 1.x 版本</li> <li>Greenwich 版本基于 SpringBoot2.1.x 版本进行构建，不能兼容 1.x 版本</li> <li>Hoxton 版本基于 SpringBoot2.2.x 版本进行构建</li> </ul> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20200709112427684.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20200709112427684.png" alt="image-20200709112427684" style></a></p> <h2 id="2环境搭建">2、环境搭建<a class="headerlink" href="#2环境搭建" title="锚点链接">¶</a></h2> <p>说明：</p> <ul> <li>SpringBoot 2.2.5.RELEASE</li> <li>SpringCloud Hoxten.SR6</li> <li>Java 11</li> <li>Maven 3.8.1</li> <li>IDEA 2021.1</li> </ul> <p>新建一个空项目，在空项目中新建一个 Maven 子项目用于版本管理（可以删除 src 目录只留 pom.xml）:</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">&lt;project</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">         </span><span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">         </span><span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">    </span><span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>com.orichalcos<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>springcloud_parent<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="cm">&lt;!--继承SpringBoot的父项目--&gt;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">    </span><span class="nt">&lt;parent&gt;</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">        </span><span class="nt">&lt;version&gt;</span>2.2.5.RELEASE<span class="nt">&lt;/version&gt;</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">    </span><span class="nt">&lt;/parent&gt;</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">    </span><span class="cm">&lt;!--定义SpringCloud使用版本号--&gt;</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">    </span><span class="nt">&lt;properties&gt;</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">        </span><span class="nt">&lt;maven.compiler.source&gt;</span>11<span class="nt">&lt;/maven.compiler.source&gt;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">        </span><span class="nt">&lt;maven.compiler.target&gt;</span>11<span class="nt">&lt;/maven.compiler.target&gt;</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="w">        </span><span class="nt">&lt;spring-cloud.version&gt;</span>Hoxton.SR6<span class="nt">&lt;/spring-cloud.version&gt;</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w">    </span><span class="nt">&lt;/properties&gt;</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="w">    </span><span class="cm">&lt;!--维护版本--&gt;</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="w">    </span><span class="nt">&lt;dependencyManagement&gt;</span>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="w">        </span><span class="nt">&lt;dependencies&gt;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="w">            </span><span class="cm">&lt;!--维护SpringCloud版本依赖--&gt;</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="w">            </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a><span class="w">                </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="w">                </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="w">                </span><span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="w">                </span><span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a><span class="w">                </span><span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="w">            </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="w">        </span><span class="nt">&lt;/dependencies&gt;</span>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="w">    </span><span class="nt">&lt;/dependencyManagement&gt;</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="nt">&lt;/project&gt;</span>
</span></code></pre></div> <h2 id="3服务注册中心">3、服务注册中心<a class="headerlink" href="#3服务注册中心" title="锚点链接">¶</a></h2> <p>所谓服务注册中心就是在整个的微服务架构中单独提出一个服务，这个服务不完成系统的任何的业务功能，仅仅用来完成对整个微服务系统的服务注册和服务发现，以及对服务健康状态的监控和管理功能。</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20200709124952525.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20200709124952525.png" alt="image-20200709124952525" style></a></p> <p>服务注册中心：</p> <ul> <li>可以对所有的微服务的信息进行存储，如微服务的名称、IP、端口等</li> <li>可以在进行服务调用时通过服务发现查询可用的微服务列表及网络地址进行服务调用</li> <li>可以对所有的微服务进行心跳检测，如发现某实例长时间无法访问，就会从服务注册表移除该实例</li> </ul> <p>SpringCloud 支持多种注册中心：Eureka、Consul、Zookeeper、以及阿里巴巴推出 Nacos。这些注册中心在本质上都是用来管理服务的注册和发现以及服务状态的检查的。</p> <h3 id="31eureka">3.1、Eureka<a class="headerlink" href="#31eureka" title="锚点链接">¶</a></h3> <p>Eureka 是 Netflix 开发的服务发现框架，本身是一个基于 REST 的服务。SpringCloud 将它集成在其子项目 spring-cloud-netflix 中，以实现SpringCloud 的服务注册和发现功能。</p> <p>Eureka 包含两个组件：Eureka Server 和 Eureka Client。</p> <h4 id="311开发-eureka-server">3.1.1、开发 Eureka Server<a class="headerlink" href="#311开发-eureka-server" title="锚点链接">¶</a></h4> <ol> <li> <p>创建一个 Maven 项目并引入 Eureka Server 依赖</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nt">&lt;dependencies&gt;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></div> </li> <li> <p>编写配置文件 application.properties</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1">#执行服务端口</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="na">server.port</span><span class="o">=</span><span class="s">8761</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1">#指定服务名称 唯一标识</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="na">spring.application.name</span><span class="o">=</span><span class="s">eurekaserver</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1">#指定服务注册中心的地址</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="na">eureka.client.service-url.defaultZone</span><span class="o">=</span><span class="s">http://localhost:8761/eureka</span>
</span></code></pre></div> </li> <li> <p>编写入口类 EurekaServer8761Application.java 并添加开启 Eureka Server 注解</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nd">@EnableEurekaServer</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EurekaServer8761Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">EurekaServer8761Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>启动项目，访问 Eureka 的服务注册页面：http://localhost:8761</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210713122030329.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210713122030329.png" alt="image-20210713122030329" style></a></p> </li> <li> <p>同时在项目启动的时候控制台会报错</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210713122150531.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210713122150531.png" alt="image-20210713122150531" style></a></p> <p>出现上述问题原因：EurekaServer 依赖内部包含了 EurekaClient</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714002253735.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714002253735.png" alt="image-20210714002253735" style></a></p> <p>Server 是一个服务注册中心，用来接受客户端的注册。Client 的特性会让当前启动的服务把自己作为 Eureka 的客户端进行服务中心的注册，当项目启动时服务注册中心还没有创建好，所以找不到服务的客户端组件就直接报错了，当启动成功服务注册中心创建好了，Client 就能进行注册并且不再报错啦！</p> </li> <li> <p>关闭 Eureka 自己注册自己</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1">#不再将自己同时作为客户端注册</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="na">eureka.client.register-with-eureka</span><span class="o">=</span><span class="s">false</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="c1">#关闭作为客户端时从Eureka Server获取服务信息</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="na">eureka.client.fetch-registry</span><span class="o">=</span><span class="s">false</span>
</span></code></pre></div> </li> <li> <p>再次启动，当前应用就是一个单纯 Eureka Server，控制器也不再报错</p> </li> </ol> <h4 id="312开发-eureka-client">3.1.2、开发 Eureka Client<a class="headerlink" href="#312开发-eureka-client" title="锚点链接">¶</a></h4> <ol> <li> <p>创建一个 Maven 子项目并引入 Spring Web 和 Eureka Client 依赖</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nt">&lt;dependencies&gt;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></div> </li> <li> <p>编写配置文件 application.properties</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1">#执行服务端口</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="na">server.port</span><span class="o">=</span><span class="s">8888</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1">#指定服务名称 唯一标识</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="na">spring.application.name</span><span class="o">=</span><span class="s">eurekaclient</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1">#eureka注册中心地址</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="na">eureka.client.service-url.defaultZone</span><span class="o">=</span><span class="s">http://localhost:8761/eureka</span>
</span></code></pre></div> </li> <li> <p>编写入口类 EurekaClient8888Application.java 并添加开启 Eureka Client 注解</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nd">@EnableEurekaClient</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EurekaClient8888Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">EurekaClient8888Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>启动之前的 Eureka Server，再启动 Eureka Client</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714001817434.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714001817434.png" alt="image-20210714001817434" style></a></p> </li> <li> <p>查看 Eureka Server 的服务注册情况</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714001846314.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714001846314.png" alt="image-20210714001846314" style></a></p> </li> </ol> <h4 id="313eureka-server-集群">3.1.3、Eureka Server 集群<a class="headerlink" href="#313eureka-server-集群" title="锚点链接">¶</a></h4> <ol> <li> <p>首先在本地 hosts 文件中配置如下映射</p> <div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>127.0.0.1 peer1
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>127.0.0.1 peer2
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>127.0.0.1 peer3
</span></code></pre></div> </li> <li> <p>将 Eureka Server 的配置文件转为 application.yml，增加三个 <code>profile</code>，分别对应三个 Eureka Server 的配置</p> <div class="language-yaml highlight"><span class="filename">YAML</span><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">  </span><span class="nt">application</span><span class="p">:</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eruekaserver</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="nt">eureka</span><span class="p">:</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">  </span><span class="nt">client</span><span class="p">:</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="nn">---</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peer1</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8761</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="nt">eureka</span><span class="p">:</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">  </span><span class="nt">instance</span><span class="p">:</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peer1</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">  </span><span class="nt">client</span><span class="p">:</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://peer2:8762/eureka,http://peer3:8763/eureka</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="nn">---</span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peer2</span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8762</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="nt">eureka</span><span class="p">:</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="w">  </span><span class="nt">instance</span><span class="p">:</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28" href="#__codelineno-9-28"></a><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peer2</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29" href="#__codelineno-9-29"></a><span class="w">  </span><span class="nt">client</span><span class="p">:</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30" href="#__codelineno-9-30"></a><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31" href="#__codelineno-9-31"></a><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://peer1:8761/eureka,http://peer3:8763/eureka</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32" href="#__codelineno-9-32"></a>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33" href="#__codelineno-9-33"></a><span class="nn">---</span>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34" href="#__codelineno-9-34"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35" href="#__codelineno-9-35"></a><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peer3</span>
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36" href="#__codelineno-9-36"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37" href="#__codelineno-9-37"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8763</span>
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38" href="#__codelineno-9-38"></a><span class="nt">eureka</span><span class="p">:</span>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39" href="#__codelineno-9-39"></a><span class="w">  </span><span class="nt">instance</span><span class="p">:</span>
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40" href="#__codelineno-9-40"></a><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">peer3</span>
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41" href="#__codelineno-9-41"></a><span class="w">  </span><span class="nt">client</span><span class="p">:</span>
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42" href="#__codelineno-9-42"></a><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span>
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43" href="#__codelineno-9-43"></a><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://peer1:8761/eureka,http://peer2:8762/eureka</span>
</span></code></pre></div> </li> <li> <p>分别启动三个注册中心，环境变量 <code>spring.profiles.active</code> 激活对应的集群配置</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714153603951.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714153603951.png" alt="image-20210714153603951" style></a></p> <p>启动之后访问 <code>http://peer1:8761/</code> 进入 <code>peer1</code> 这个注册中心，就可以看到另外两个分片 <code>peer2、peer3</code>，说明集群中有3个节点了</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714154331476.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714154331476.png" alt="image-20210714154331476" style></a></p> <p>再去访问其他两个注册中也能看到另外两个分片</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714154403887.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714154403887.png" alt="image-20210714154403887" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714154423775.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714154423775.png" alt="image-20210714154423775" style></a></p> <p>并且可以看到虽然 Eureka Client 之注册到了第一个 Eureka Server 上，但是可以看到 Eureka Server 节点之间的实例会相互同步</p> </li> </ol> <h4 id="314eureka-自我保护机制">3.1.4、Eureka 自我保护机制<a class="headerlink" href="#314eureka-自我保护机制" title="锚点链接">¶</a></h4> <p>首先 Eureka 注册中心各个节点都是平等的，没有 ZK 中角色的概念， 即使 N-1 个节点挂掉也不会影响其他节点的正常运行。</p> <p>默认情况下，如果 Eureka Server 在一定时间内（默认90秒）没有接收到某个微服务实例的心跳，Eureka Server 将会移除该实例。但是当网络分区故障发生时，微服务与 Eureka Server 之间无法正常通信，而微服务本身是正常运行的，此时不应该移除这个微服务，所以引入了自我保护机制。</p> <blockquote> <p><strong>Eureka心跳机制</strong></p> <p>在应用启动后，节点们将会向 Eureka Server 发送心跳，默认周期为 30 秒，如果 Eureka Server 在多个心跳周期内没有接收到某个节点的心跳，Eureka Server 将会从服务注册表中把这个服务节点移除（默认90秒）。</p> </blockquote> <p>如果在 Eureka Server 的首页看到以下这段提示，则说明 Eureka 已经进入了保护模式。 </p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714185558794.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714185558794.png" alt="image-20210714185558794" style></a></p> <p>Eureka Server 自动进入自我保护机制，此时会出现以下几种情况：</p> <ol> <li>Eureka Server 不再从注册列表中移除因为长时间没收到心跳而应该过期的服务</li> <li>Eureka Server 仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上，保证当前节点依然可用</li> <li>当网络稳定时，当前 Eureka Server 新的注册信息会被同步到其它节点中</li> </ol> <p>因此 Eureka Server 可以很好的应对因网络故障导致部分节点失联的情况，而不会像 ZK 那样如果有一半不可用的情况会导致整个集群不可用而变成瘫痪。</p> <p><strong>关闭自我保护</strong></p> <ol> <li> <p>Eureka Server 端：配置关闭自我保护，并按需配置 Eureka Server 清理无效节点的时间间隔</p> <div class="language-yaml highlight"><span class="filename">YAML</span><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">eureka</span><span class="p">:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="c1">#设为false，关闭自我保护 </span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="nt">enable-self-preservation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="c1">#清理间隔（单位毫秒，默认是60*1000） </span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="nt">eviction-interval-timer-in-ms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</span></code></pre></div> </li> <li> <p>Eureka Client 端：配置开启健康检查，并按需配置续约更新时间和到期时间</p> <div class="language-yaml highlight"><span class="filename">YAML</span><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">eureka</span><span class="p">:</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">  </span><span class="nt">instance</span><span class="p">:</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="c1">#续约更新时间间隔（默认30秒</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="nt">lease-renewal-interval-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">    </span><span class="c1">#续约到期时间（默认90秒） </span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">    </span><span class="nt">lease-expiration-duration-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</span></code></pre></div> </li> </ol> <p>注意：更改 Eureka 更新频率将打破服务器的自我保护功能，生产环境下不建议自定义这些配置：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714192047475.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714192047475.png" alt="image-20210714192047475" style></a></p> <blockquote> <p>关于 Eureka 2.x 的开源工作已经停止。作为 2.x 分支上现有工作存储库的一部分发布的代码库和工件被视为使用风险自负，在 1.x 版本项目还是活跃的。</p> </blockquote> <h3 id="32consul">3.2、Consul<a class="headerlink" href="#32consul" title="锚点链接">¶</a></h3> <p>Consul 是 HashiCorp 公司推出的开源工具，用于实现分布式系统的服务发现与配置。与其它分布式服务注册与发现的方案，Consul 的方案更 “一站式”，内置了服务注册与发现框架、分布一致性协议实现、健康检查、Key/Value 存储、多数据中心方案，不再需要依赖其它工具（比如 ZooKeeper 等）。使用起来也较为简单。Consul 使用 Go 语言编写，因此具有天然可移植性（支持Linux、windows和Mac OS X）；安装包仅包含一个可执行文件，方便部署，与 Docker 等轻量级容器可无缝配合。</p> <h4 id="321安装-consul">3.2.1、安装 Consul<a class="headerlink" href="#321安装-consul" title="锚点链接">¶</a></h4> <p><strong>Windows 下安装 Consul</strong></p> <ol> <li> <p>前往 https://www.consul.io/downloads</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714233845045.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714233845045.png" alt="image-20210714233845045" style></a></p> <p>选择自己电脑对应的版本下载</p> </li> <li> <p>解压完后只有一个脚本文件</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714234043504.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714234043504.png" alt="image-20210714234043504" style></a></p> </li> <li> <p>使用终端切换到 consul.exe 目录并执行以下命令启动 Consul</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714235520532.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714235520532.png" alt="image-20210714235520532" style></a></p> </li> <li> <p>访问 Consul 的 WEB 服务端口：http://localhost:8500</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210714235639426.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210714235639426.png" alt="image-20210714235639426" style></a></p> <p>左上角 Consul logo 旁边的 dc1 为数据中心，可以通过 <code>-datacenter</code> 进行设置：</p> <div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>consul<span class="w"> </span>agent<span class="w"> </span>-dev<span class="w"> </span>-datacenter<span class="o">=</span>aa
</span></code></pre></div> </li> </ol> <p>可以通过设置环境变量，不用更改终端路径，直接执行 Consul 命令：</p> <ol> <li> <p>新建一个环境变量，路径指向 consul.exe 的文件夹</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210715000050208.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210715000050208.png" alt="image-20210715000050208" style></a></p> </li> <li> <p>在系统变量 Path 中将刚刚添加的变量加上</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210715000501565.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210715000501565.png" alt="image-20210715000501565" style></a></p> </li> <li> <p>赶紧试试~</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210715000842740.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210715000842740.png" alt="image-20210715000842740" style></a></p> </li> </ol> <blockquote> <p>如果前面使用的是 Windows CMD 开启了 Consul，记得按 Ctrl + C 关闭，然后还需重新启动 CMD</p> </blockquote> <h4 id="322开发-consul-client">3.2.2、开发 Consul Client<a class="headerlink" href="#322开发-consul-client" title="锚点链接">¶</a></h4> <ol> <li> <p>创建项目并引入 Spring Web 和 Consul 客户端依赖</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nt">&lt;dependencies&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-consul-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></div> </li> <li> <p>编写配置文件 application.properties</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="na">server.port</span><span class="o">=</span><span class="s">8889</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="c1">#注册consul服务的主机</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="na">spring.application.name</span><span class="o">=</span><span class="s">consulclient</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="na">spring.cloud.consul.host</span><span class="o">=</span><span class="s">localhost</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="c1">#注册consul服务的端口号</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="na">spring.cloud.consul.port</span><span class="o">=</span><span class="s">8500</span>
</span></code></pre></div> </li> <li> <p>编辑 ConsulClient8889Application.class 入口类并添加开启客户端发现注解</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="nd">@EnableDiscoveryClient</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ConsulClient8889Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">ConsulClient8889Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>启动服务查看 Consul 界面服务信息</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210715173835645.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210715173835645.png" alt="image-20210715173835645" style></a></p> </li> <li> <p>默认情况 Consul 监控健康是开启的，但是必须依赖健康监控依赖才能正确监控健康状态，所以直接启动会显示错误，引入健康监控依赖之后服务正常</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="cm">&lt;!-- 这个包是用做健康度监控的--&gt;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div> </li> <li> <p>引入成功后重启项目，刷新 Consul 监控页面：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210715175633678.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210715175633678.png" alt="image-20210715175633678" style></a></p> </li> </ol> <h2 id="4服务调用组件">4、服务调用组件<a class="headerlink" href="#4服务调用组件" title="锚点链接">¶</a></h2> <p>接下来在整个微服务架构中，我们比较关心的就是服务间的服务改如何调用，有哪些调用方式？</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20200713095528763.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20200713095528763.png" alt="image-20200713095528763" style></a></p> <p>在 SpringCloud 中服务间调用方式主要是使用 HTTP RESTful 方式进行服务间调用</p> <h3 id="41resttemplate">4.1、RestTemplate<a class="headerlink" href="#41resttemplate" title="锚点链接">¶</a></h3> <p>Spring 框架提供的 RestTemplate 类可用于在应用中调用 REST 服务，它简化了与 HTTP 服务的通信方式，统一了 RESTful 的标准，封装了 HTTP 链接， 我们只需要传入url 及返回值类型即可。相较于之前常用的 HttpClient，RestTemplate 是一种更优雅的调用 RESTful 服务的方式。</p> <p><strong>发送简单的请求</strong></p> <ol> <li> <p>创建两个服务并注册到 Consul 注册中心中</p> <ul> <li>users 代表用户服务，端口为 9999</li> <li>order 代表订单服务，端口为 9998</li> </ul> <p>注意：这里服务仅仅用来测试，没有实际业务意义</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210801002648820.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210801002648820.png" alt="image-20210801002648820" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210801002754756.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210801002754756.png" alt="image-20210801002754756" style></a></p> </li> <li> <p>创建一个 OrderController 提供服务：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="nd">@RestController</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/order"</span><span class="p">)</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">OrderController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="nd">@GetMapping</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">demo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"order demo..."</span><span class="p">);</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"order demo OK!!"</span><span class="p">;</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>创建一个 UserController 调用订单服务：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nd">@RestController</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/user"</span><span class="p">)</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">UserController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">    </span><span class="nd">@GetMapping</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">invokeDemo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"user demo..."</span><span class="p">);</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">        </span><span class="c1">//调用订单服务 服务地址： http://localhost:9999/order 必须GET方式 接收返回值 String 类型</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">        </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">orderResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="s">"http://localhost:9998/order"</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"调用订单服务成功:{}"</span><span class="p">,</span><span class="w"> </span><span class="n">orderResult</span><span class="p">);</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"调用订单服务成功,结果为:"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">orderResult</span><span class="p">;</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>先启动 Consul，再启动 User 服务和 Order 服务，然后 http://localhost:9999/user 测试：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210804004640357.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210804004640357.png" alt="image-20210804004640357" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210804004717424.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210804004717424.png" alt="image-20210804004717424" style></a></p> </li> </ol> <p><strong>发送 GET 请求添加请求头 Headers 并携带参数</strong></p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span><span class="w"> </span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UriComponentsBuilder</span><span class="p">.</span><span class="na">fromHttpUrl</span><span class="p">(</span><span class="s">"http://localhost:8080"</span><span class="p">)</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">                </span><span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span><span class="w"> </span><span class="s">"张三"</span><span class="p">)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">                </span><span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"sex"</span><span class="p">,</span><span class="w"> </span><span class="s">"男"</span><span class="p">)</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">                </span><span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"national"</span><span class="p">,</span><span class="w"> </span><span class="s">"中国"</span><span class="p">)</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">                </span><span class="p">.</span><span class="na">queryParam</span><span class="p">(</span><span class="s">"birthday"</span><span class="p">,</span><span class="w"> </span><span class="s">"199002190"</span><span class="p">)</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">().</span><span class="na">encode</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="n">HttpHeaders</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpHeaders</span><span class="p">();</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="n">headers</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="s">"Accept"</span><span class="p">,</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON_VALUE</span><span class="p">);</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="n">HttpEntity</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">headers</span><span class="p">);</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="n">JSONObject</span><span class="w"> </span><span class="n">jsonObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">JSONObject</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">);</span>
</span></code></pre></div> <p><strong>发送 POST 请求并添加请求头 Headers 和请求体 Body</strong></p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="n">HttpHeaders</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpHeaders</span><span class="p">();</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="n">headers</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">);</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="n">headers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">);</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="c1">// MultiValueMap&lt;String, Object&gt; map=new LinkedMultiValueMap&lt;&gt;();</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">"username"</span><span class="p">,</span><span class="w"> </span><span class="s">"Orichalcos"</span><span class="p">);</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">"password"</span><span class="p">,</span><span class="w"> </span><span class="s">"OriPass"</span><span class="p">);</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a><span class="n">HttpEntity</span><span class="o">&lt;</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">httpEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HttpEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">map</span><span class="p">,</span><span class="w"> </span><span class="n">headers</span><span class="p">);</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="n">JSONObject</span><span class="w"> </span><span class="n">jsonObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">postForObject</span><span class="p">(</span><span class="s">"url"</span><span class="p">,</span><span class="w"> </span><span class="n">httpEntity</span><span class="p">,</span><span class="w"> </span><span class="n">JSONObject</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span></code></pre></div> <blockquote> <p>当没有请求头信息时，用 <code>MultiValueMap&lt;String, Object&gt; map=new LinkedMultiValueMap&lt;&gt;();</code></p> <p>当有请求头信息时，用 <code>HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;();</code></p> </blockquote> <p>上述代码设置了 <code>headers</code> 里面的 <code>Content-Type</code> 为 <code>application/json</code> ，添加了一个 <code>Authorization</code> 属性，<code>body</code> 里设置了用户名和密码。如果想要设置更复杂的 <code>Content_Type</code> 可以使用以下方法：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">MediaType</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MediaType</span><span class="p">.</span><span class="na">parseMediaType</span><span class="p">(</span><span class="s">"application/json;charset=UTF-8"</span><span class="p">);</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="n">httpHeaders</span><span class="p">.</span><span class="na">setContentType</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
</span></code></pre></div> <blockquote> <p>如果想要获取更为完整的响应，可以使用 <code>postForEntity()</code>。</p> <p><code>getForObject()</code> 函数实际上是对 <code>getForEntity()</code> 函数的进一步封装，如果你只关注返回的消息体的内容，对其他信息都不关注，此时可以使用 <code>getForObject()</code>。</p> </blockquote> <p><strong>发送其他类型的 HTTP 请求</strong></p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">exchange</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">HttpMethod</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="n">HttpEntity</span><span class="w"> </span><span class="n">requestEntity</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="w"> </span><span class="n">responseType</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="p">...</span><span class="w"> </span><span class="n">uriVariables</span><span class="p">)</span>
</span></code></pre></div> <p>参数说明：</p> <ul> <li><em>url</em>：请求路径</li> <li><em>method</em>：请求的方法（GET、POST、PUT等）</li> <li><em>requestEntity</em>：HttpEntity 对象，封装了请求头和请求体</li> <li><em>responseType</em>：返回数据类型</li> <li><em>uriVariables</em>：支持 PathVariable 类型的数据。</li> </ul> <h3 id="42openfeign">4.2、OpenFeign<a class="headerlink" href="#42openfeign" title="锚点链接">¶</a></h3> <p>Feign 是一个声明式的伪 HTTP 客户端，它使得写 HTTP 客户端变得更简单。使用 Feign，只需要创建一个接口并添加注解。它具有可插拔的注解特性，可以使用 SpringMVC 的注解，可使用 Feign 注解和 JAX-RS 注解。Feign 支持可插拔的编码器和解码器。Feign 默认集成了 Ribbon，默认实现了负载均衡的效果并且 SpringCloud 为 Feign 添加了 SpringMVC 注解的支持。</p> <h4 id="421openfeign-服务调用">4.2.1、OpenFeign 服务调用<a class="headerlink" href="#421openfeign-服务调用" title="锚点链接">¶</a></h4> <ol> <li> <p>新建两个服务 Category、Product，并将其注册到 Consul 中（Product 可根据启动文件启动两个，用于测试负载均衡）</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210822234802589.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210822234802589.png" alt="image-20210822234802589" style></a></p> </li> <li> <p>在 Product 服务中提供一个被调用接口：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nd">@RestController</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ProductController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">ProductController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">"${server.port}"</span><span class="p">)</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/product"</span><span class="p">)</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">product</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"进入商品服务....."</span><span class="p">);</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"product ok，当前提供服务窗口："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在服务调用方 Category 中添加 OpenFeign 依赖：</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="cm">&lt;!--OpenFeign依赖--&gt;</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div> </li> <li> <p>在 Category 启动类上添加注解，开启 OpenFeign 客户端调用：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nd">@EnableDiscoveryClient</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="c1">//开启OpenFeign客户端调用</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="nd">@EnableFeignClients</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Category9995Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">Category9995Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务中添加一个客户端调用接口：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="c1">//调用商品服务接口 value：用来书写被调用服务的服务Id</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="nd">@FeignClient</span><span class="p">(</span><span class="s">"product"</span><span class="p">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ProductClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">    </span><span class="c1">//调用商品服务</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/product"</span><span class="p">)</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">product</span><span class="p">();</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务中添加 Controller，使用 FeignClient 客户端对象调用服务：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nd">@RestController</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CategoryController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">CategoryController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="nd">@Autowired</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ProductClient</span><span class="w"> </span><span class="n">productClient</span><span class="p">;</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/category"</span><span class="p">)</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">category</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productClient</span><span class="p">.</span><span class="na">product</span><span class="p">();</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"category service....."</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"category ok...."</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="p">}</span>
</span></code></pre></div> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210822233948054.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210822233948054.png" alt="image-20210822233948054" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210822235320696.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210822235320696.png" alt="image-20210822235320696" style></a></p> </li> </ol> <h4 id="422调用服务并传参">4.2.2、调用服务并传参<a class="headerlink" href="#422调用服务并传参" title="锚点链接">¶</a></h4> <p>服务和服务之间通信，不仅仅是调用，往往在调用过程中还伴随着参数传递，接下来重点来看看 OpenFeign 在调用服务时如何传递参数。</p> <p><strong>GET 方式调用服务传递参数</strong></p> <ol> <li> <p>在 Product 服务中添加如下方法：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">//定义一个接收零散类型参数接口 queryString</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test1"</span><span class="p">)</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test1</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"name:{} age:{}"</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">);</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"test1 ok，当前服务端口为："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务 ProductClient.java 中添加接口：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test1"</span><span class="p">)</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">String</span><span class="w"> </span><span class="nf">test1</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">"age"</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">age</span><span class="p">);</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务中调用：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test1"</span><span class="p">)</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test1</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productClient</span><span class="p">.</span><span class="na">test1</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="p">);</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"category ok....."</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>访问：http://localhost:9995/test1?name=Orichalcos&amp;age=18</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210901000521366.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210901000521366.png" alt="image-20210901000521366" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210831235811079.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210831235811079.png" alt="image-20210831235811079" style></a></p> </li> </ol> <p><strong>POST 方式调用服务传递参数</strong></p> <ol> <li> <p>在 Product 服务中添加如下方法：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="c1">//定义一个接收零散类型参数接口 路径传递参数</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test2/{id}/{name}"</span><span class="p">)</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test2</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"id:{} name{}"</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"test2 ok，当前服务端口为："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务 ProductClient.java 中添加接口：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test2/{id}/{name}"</span><span class="p">)</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="n">String</span><span class="w"> </span><span class="nf">test2</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务中调用：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test2/{id}/{name}"</span><span class="p">)</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test2</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">"name"</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productClient</span><span class="p">.</span><span class="na">test2</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"category ok....."</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>访问：http://localhost:9995/test2/1/Orichalcos</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210901001120701.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210901001120701.png" alt="image-20210901001120701" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210901001139833.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210901001139833.png" alt="image-20210901001139833" style></a></p> </li> </ol> <p><strong>传递对象参数 application/json 格式</strong></p> <ol> <li> <p>在 Product 和 Category 服务中创建一个 Product 实体类，并增加 get/set、有参无参构造函数：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Product</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Double</span><span class="w"> </span><span class="n">price</span><span class="p">;</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Date</span><span class="w"> </span><span class="n">bir</span><span class="p">;</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 Product 服务中添加如下方法：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1">//定义一个接收对象类型参数接口 application/json</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">"/test3"</span><span class="p">)</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test3</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"product:{}"</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">);</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"test3 ok，当前服务端口为："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务 ProductClient.java 中添加接口：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="nd">@PostMapping</span><span class="p">(</span><span class="s">"/test3"</span><span class="p">)</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="n">String</span><span class="w"> </span><span class="nf">test3</span><span class="p">(</span><span class="nd">@RequestBody</span><span class="w"> </span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">);</span>
</span></code></pre></div> </li> <li> <p>在 Category 服务中调用：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test3"</span><span class="p">)</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test3</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">productClient</span><span class="p">.</span><span class="na">test3</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Product</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">"Orichalcos"</span><span class="p">,</span><span class="w"> </span><span class="mf">19.9</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Date</span><span class="p">()));</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"category ok....."</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>访问：http://localhost:9995/test3</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210901003708149.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210901003708149.png" alt="image-20210901003708149" style></a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210901003732017.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210901003732017.png" alt="image-20210901003732017" style></a></p> </li> </ol> <h4 id="423openfeign-超时设置">4.2.3、OpenFeign 超时设置<a class="headerlink" href="#423openfeign-超时设置" title="锚点链接">¶</a></h4> <p>默认情况下，OpenFiegn 在进行服务调用时，要求服务提供方处理业务逻辑时间必须在 1S 内返回，如果超过 1S 没有返回则 OpenFeign 会直接报错，不会等待服务执行，但是往往在处理复杂业务逻辑是可能会超过 1S，因此需要修改 OpenFeign 的默认服务调用超时时间。</p> <p>调用超时会出现如下错误</p> <ol> <li> <p>在服务提供方加入线程等待阻塞模拟超时：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/product"</span><span class="p">)</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">product</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">InterruptedException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"进入商品服务....."</span><span class="p">);</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"product ok，当前提供服务窗口："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>进行客户端调用：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211102000512159.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211102000512159.png" alt="image-20211102000512159" style></a></p> </li> </ol> <p>修改 OpenFeign 默认超时时间：</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="na">feign.client.config.PRODUCTS.connectTimeout</span><span class="o">=</span><span class="s">5000        #配置指定服务连接超时</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="na">feign.client.config.PRODUCTS.readTimeout</span><span class="o">=</span><span class="s">5000           #配置指定服务等待超时</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="c1">#feign.client.config.default.connectTimeout=5000        #配置所有服务连接超时</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="c1">#feign.client.config.default.readTimeout=5000           #配置所有服务等待超时</span>
</span></code></pre></div> <h4 id="424日志展示">4.2.4、日志展示<a class="headerlink" href="#424日志展示" title="锚点链接">¶</a></h4> <p>往往在服务调用时我们需要详细展示 Feign 的日志，默认 Feign 在调用是并不是最详细日志输出，因此在调试程序时应该开启 Feign 的详细日志展示。Feign 对日志的处理非常灵活，可为每个 Feign 客户端指定日志记录策略，每个客户端都会创建一个 logger，默认情况下 logger 的名称是Feign 的全限定名需要注意的是，Feign 日志的打印只会DEBUG级别做出响应。</p> <p>我们可以为 Feign 客户端配置各自的 logger.lever 对象，告诉 Feign 记录那些日志 logger.lever 有以下的几种值：</p> <ul> <li>NONE 不记录任何日志</li> <li>BASIC 仅仅记录请求方法、url、响应状态代码及执行时间</li> <li>HEADERS 记录Basic级别的基础上，记录请求和响应的header</li> <li> <p>FULL 记录请求和响应的header、body和元数据</p> </li> <li> <p>开启日志展示</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="na">feign.client.config.PRODUCTS.loggerLevel</span><span class="o">=</span><span class="s">full     #开启指定服务日志展示</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="c1">#feign.client.config.default.loggerLevel=full     #全局开启服务日志展示</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="na">logging.level.com.orichalcos.feignclient</span><span class="o">=</span><span class="s">debug    #指定feign调用客户端对象所在包,必须是debug级别</span>
</span></code></pre></div> </li> <li> <p>测试服务调用查看日志</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211102001811337.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211102001811337.png" alt="image-20211102001811337" style></a></p> </li> </ul> <h2 id="5服务负载均衡">5、服务负载均衡<a class="headerlink" href="#5服务负载均衡" title="锚点链接">¶</a></h2> <h3 id="51ribbon">5.1、Ribbon<a class="headerlink" href="#51ribbon" title="锚点链接">¶</a></h3> <p>Spring Cloud Ribbon 是一个基于 HTTP 和 TCP 的客户端负载均衡工具，它基于 Netflix Ribbon 实现。通过 Spring Cloud 的封装，可以让我们轻松地将面向服务的 REST 模版请求自动转换成客户端负载均衡的服务调用。</p> <h4 id="511ribbon-服务调用">5.1.1、Ribbon 服务调用<a class="headerlink" href="#511ribbon-服务调用" title="锚点链接">¶</a></h4> <p><strong>准备工作</strong></p> <ol> <li> <p>项目中引入依赖：</p> <ul> <li> <p>如果使用的是 Eureka Client 和 Consul Client，无须引入依赖，因为在 Eureka、Consul 中默认集成了 Ribbon 组件</p> </li> <li> <p>如果使用的 Client 中没有 Ribbon 依赖需要显式引入如下依赖</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="cm">&lt;!--引入ribbon依赖--&gt;</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-ribbon<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div> </li> </ul> </li> <li> <p>修改 Order 服务的控制器</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="nd">@RestController</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/order"</span><span class="p">)</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OrderController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">OrderController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">    </span><span class="nd">@Value</span><span class="p">(</span><span class="s">"${server.port}"</span><span class="p">)</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span><span class="nd">@GetMapping</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">demo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"order被调用，服务端口为：{}"</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"order demo OK!!,服务端口为："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>修改 Order 服务的配置文件，，增加三个 <code>profile</code></p> <div class="language-yaml highlight"><span class="filename">YAML</span><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">  </span><span class="nt">application</span><span class="p">:</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="nt">consul</span><span class="p">:</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8500</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="nn">---</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order9998</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9998</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="nn">---</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order9997</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9997</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="nn">---</span>
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="w">  </span><span class="nt">profiles</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order9996</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9996</span>
</span></code></pre></div> </li> <li> <p>分别启动三个注册中心，环境变量 <code>spring.profiles.active</code> 激活对应的集群配置</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210805002959560.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210805002959560.png" alt="image-20210805002959560" style></a></p> </li> </ol> <p><strong>RestTemplate + Ribbon 的调用方式：</strong></p> <ul> <li>使用 discovery client 进行客户端调用</li> <li>使用 loadBalanceClient 进行客户端调用</li> <li>使用 @loadBalanced 进行客户端调用</li> </ul> <p><strong>DiscoveryClient</strong></p> <p>修改 User 服务的控制器，增加以下内容</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nd">@Autowired</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="kd">private</span><span class="w"> </span><span class="n">DiscoveryClient</span><span class="w"> </span><span class="n">discoveryClient</span><span class="p">;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/discoveryClient"</span><span class="p">)</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">discoveryClient</span><span class="p">(){</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="c1">//获取服务列表</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">discoveryClient</span><span class="p">.</span><span class="na">getInstances</span><span class="p">(</span><span class="s">"order"</span><span class="p">);</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="n">orders</span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="p">{</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"服务主机：【{}】"</span><span class="p">,</span><span class="n">order</span><span class="p">.</span><span class="na">getHost</span><span class="p">());</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"服务端口：【{}】"</span><span class="p">,</span><span class="n">order</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"服务地址：【{}】"</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getUri</span><span class="p">());</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="c1">//从服务列表中随机调取一个服务</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="n">ServiceInstance</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">orders</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">().</span><span class="na">nextInt</span><span class="p">(</span><span class="n">orders</span><span class="p">.</span><span class="na">size</span><span class="p">()));</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">    </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getUri</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"/order"</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"User服务调用OK，"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="p">}</span>
</span></code></pre></div> <p>访问 http://localhost:9999/user/discoveryClient 查看，可重复刷新查看是否切换不同服务</p> <p><strong>LoadBalance Client</strong></p> <p>修改 User 服务的控制器，增加以下内容</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nd">@Autowired</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="kd">private</span><span class="w"> </span><span class="n">LoadBalancerClient</span><span class="w"> </span><span class="n">loadBalancerClient</span><span class="p">;</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/loadBalancerClient"</span><span class="p">)</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">loadBalancerClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="c1">//根据负载均衡策略选取某一个服务调用</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">    </span><span class="n">ServiceInstance</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadBalancerClient</span><span class="p">.</span><span class="na">choose</span><span class="p">(</span><span class="s">"order"</span><span class="p">);</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"服务主机：【{}】"</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getHost</span><span class="p">());</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"服务端口：【{}】"</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getPort</span><span class="p">());</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">    </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"服务地址：【{}】"</span><span class="p">,</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getUri</span><span class="p">());</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">    </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="na">getUri</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"/order"</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"User服务调用OK，"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="p">}</span>
</span></code></pre></div> <p>访问 http://localhost:9999/user/loadBalancerClient 查看，可重复刷新查看是否切换不同服务</p> <p><strong>@LoadBalanced</strong></p> <p>在 User 服务中新建一个 BeansConfig.java 来提供 RestTemplate</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">BeansConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="c1">//整合restTemplate + ribbon</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="nd">@LoadBalanced</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="p">}</span>
</span></code></pre></div> <p>修改 User 服务的控制器，增加以下内容</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="c1">//调用服务位置注入 RestTemplate</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="nd">@Autowired</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="kd">private</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">;</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/loadBalanced"</span><span class="p">)</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">loadBalanced</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">    </span><span class="c1">//调用：使用被调用服务的Id 替代 被调用服务的域名和端口号（下面第一个order为订单服务的端口号）</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="s">"http://order/order"</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"User服务调用OK，"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="p">}</span>
</span></code></pre></div> <p>访问 http://localhost:9999/user/loadBalanced 查看，可重复刷新查看是否切换不同服务</p> <h4 id="512ribbon-的负载均衡策略">5.1.2、Ribbon 的负载均衡策略<a class="headerlink" href="#512ribbon-的负载均衡策略" title="锚点链接">¶</a></h4> <p>这里可以点进自动注入的 <code>LoadBalancerClient</code>查看其源码：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807001718136.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807001718136.png" alt="image-20210807001718136" style></a></p> <p>发现并没有我们调用的 <code>choose()</code> 方法，那直接从 <code>choose()</code> 方法中点进查看，发现该方法来源自 <code>LoadBalancerClient</code> 的父接口 <code>ServiceInstanceChooser</code>：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807001930520.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807001930520.png" alt="image-20210807001930520" style></a></p> <p>点击选中 <code>LoadBalancerClient</code> 按 F4 查看其实现，<code>ServiceInstanceChooser</code> 的 <code>choose()</code> 方法默认实现为 <code>RiibonLoadBalancerClient</code>：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807002537050.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807002537050.png" alt="image-20210807002537050" style></a></p> <p>在 <code>RiibonLoadBalancerClient</code> 的 <code>choose()</code> 方法中可以看到它又调用了自己的 <code>choose()</code> 方法，由方法中的 <code>getServer()</code> 方法获取服务：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807002831290.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807002831290.png" alt="image-20210807002831290" style></a></p> <p>继续追下去，发现 <code>getServer()</code> 又调用了 <code>chooseServer()</code>：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807003135718.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807003135718.png" alt="image-20210807003135718" style></a></p> <p>再点进去就发现进入了 <code>ILoadBalancer</code> 接口了，查看方法实现，发现有三个实现：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807003744210.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807003744210.png" alt="image-20210807003744210" style></a></p> <p>这里可以打个断点，然后使用 Step Into 追踪，会发现会调用 <code>ZoneAwareLoadBalancer</code> 的实现，而 <code>ZoneAwareLoadBalancer</code> 会调用父类的 <code>chooseServer()</code>：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807004001423.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807004001423.png" alt="image-20210807004001423" style></a></p> <p>继续追下去，发现到了 <code>BaseLoadBalancer</code> 中，这里有许多判断，用 dbug 可以清晰地看到判断一路走到了 <code>this.rule.choose(key)</code>：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807004405986.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807004405986.png" alt="image-20210807004405986" style></a></p> <p>再点下去就到了关键的接口 <code>IRule</code>:</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807005034400.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807005034400.png" alt="image-20210807005034400" style></a></p> <p>这个接口定义 LoadBalancer 的 “规则”，规则可以被看作是负载均衡的策略。众所周知的负载均衡策略包括轮询、基于响应时间等。而 <code>choose()</code> 上面注解解释了：通过 <code>key</code> 从 <code>lb.allServers</code> 中选择一个活的服务器。</p> <p>到了这里已经很明朗了，<code>IRule</code> 就是所有负载均衡的父接口，点击这里的 <code>rule</code> 变量可以看到默认的负载均衡策略为轮询：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807010401158.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807010401158.png" alt="image-20210807010401158" style></a></p> <p>可以通过 IDEA 查看 <code>IRule</code> 的所有实现：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20210807010639929.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20210807010639929.png" alt="image-20210807010639929" style></a></p> <ul> <li>RoundRobinRule 轮训策略：按顺序循环选择 Server</li> <li>RandomRule 随机策略：随机选择 Server</li> <li> <p>AvailabilityFilteringRule 可用过滤策略：会先过滤由于多次访问故障而处于断路器跳闸状态的服务，还有并发的连接数量超过阈值的服务，然后对剩余的服务列表按照轮询策略进行访问</p> </li> <li> <p>WeightedResponseTimeRule 响应时间加权策略：根据平均响应的时间计算所有服务的权重，响应时间越快服务权重越大被选中的概率越高，刚启动时如果统计信息不足，则使用RoundRobinRule策略，等统计信息足够会切换到</p> </li> <li> <p>RetryRule 重试策略：先按照RoundRobinRule的策略获取服务，如果获取失败则在制定时间内进行重试，获取可用的服务</p> </li> <li> <p>BestAviableRule 最低并发策略：会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务 </p> </li> </ul> <h4 id="513修改默认负载均衡策略">5.1.3、修改默认负载均衡策略<a class="headerlink" href="#513修改默认负载均衡策略" title="锚点链接">¶</a></h4> <p>被调用的服务id.ribbon.NFLoadBalancerRuleClassName=com.netflix.loadbalancer.RandomRule</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="c1">#修改用户服务调用订单服务默认负载均衡策略，使用随机策略</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="na">order.ribbon.NFLoadBalancerRuleClassName</span><span class="o">=</span><span class="s">com.netflix.loadbalancer.RandomRule</span>
</span></code></pre></div> <h2 id="6服务断路器">6、服务断路器<a class="headerlink" href="#6服务断路器" title="锚点链接">¶</a></h2> <h3 id="61hystrix">6.1、Hystrix<a class="headerlink" href="#61hystrix" title="锚点链接">¶</a></h3> <p>在分布式环境中，许多服务依赖项不可避免地会失败。Hystrix 是一个库，它通过添加延迟容忍和容错逻辑来帮助您控制这些分布式服务之间的交互。Hystrix 通过隔离服务之间的访问点、停止它们之间的级联故障以及提供后备选项来实现这一点，所有这些都可以提高系统的整体弹性。</p> <h4 id="611服务雪崩熔断降级">6.1.1、服务雪崩、熔断、降级<a class="headerlink" href="#611服务雪崩熔断降级" title="锚点链接">¶</a></h4> <p><strong>服务雪崩</strong></p> <p>在微服务之间进行服务调用是由于某一个服务故障，导致级联服务故障的现象，称为雪崩效应。雪崩效应描述的是提供方不可用，导致消费方不可用并将不可用逐渐放大的过程。</p> <p>如存在如下调用链路：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211103234624097.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211103234624097.png" alt="image-20211103234624097" style></a></p> <p>而此时，Service A 的流量波动很大，流量经常会突然性增加！那么在这种情况下，就算 Service A 能扛得住请求，Service B 和Service C 未必能扛得住这突发的请求。此时，如果 Service C 因为抗不住请求，变得不可用。那么 Service B 的请求也会阻塞，慢慢耗尽 Service B 的线程资源，Service B 就会变得不可用。紧接着，Service A 也会不可用，这一过程如下图所示：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211103234721085.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211103234721085.png" alt="image-20211103234721085" style></a></p> <p><strong>服务熔断</strong></p> <p>“熔断器” 本身是一种开关装置，当某个服务单元发生故障之后，通过断路器（hystrix）的故障监控，某个异常条件被触发，直接熔断整个服务。向调用方法返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方法无法处理的异常，就保证了服务调用方的线程不会被长时间占用，避免故障在分布式系统中蔓延，乃至雪崩。如果目标服务情况好转则恢复调用。服务熔断是解决服务雪崩的重要手段。</p> <p>服务熔断图示：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211103234923258.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211103234923258.png" alt="image-20211103234923258" style></a></p> <p><strong>服务降级</strong></p> <p>服务压力剧增的时候根据当前的业务情况及流量对一些服务和页面有策略的降级，以此缓解服务器的压力，以保证核心任务的进行。同时保证部分甚至大部分任务客户能得到正确的响应。也就是当前的请求处理不了或者出错了，给一个默认的返回。</p> <p>服务降级图示：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211103235406735.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211103235406735.png" alt="image-20211103235406735" style></a></p> <p><strong>降级和熔断总结</strong></p> <p>共同点：</p> <ul> <li>目的很一致，都是从可用性可靠性着想，为防止系统的整体缓慢甚至崩溃，采用的技术手段。</li> <li>最终表现类似，对于两者来说，最终让用户体验到的是某些功能暂时不可达或不可用。</li> <li>粒度一般都是服务级别，当然，业界也有不少更细粒度的做法，比如做到数据持久层（允许查询，不允许增删改）。</li> <li>自治性要求很高，熔断模式一般都是服务基于策略的自动触发，降级虽说可人工干预，但在微服务架构下，完全靠人显然不可能，开关预置、配置中心都是必要手段。</li> </ul> <p>不同点：</p> <ul> <li>触发原因不太一样，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；</li> <li>管理目标的层次不太一样，熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务边缘服务开始）</li> </ul> <p>熔断必会触发降级，所以熔断也是降级一种，区别在于熔断是对调用链路的保护，而降级是对系统过载的一种保护处理</p> <h4 id="622服务熔断的实现">6.2.2、服务熔断的实现<a class="headerlink" href="#622服务熔断的实现" title="锚点链接">¶</a></h4> <ol> <li> <p>添加一个微服务 springcloud_hystrix，并引入相关依赖：</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="cm">&lt;!--引入hystrix--&gt;</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div> </li> <li> <p>配置下 application.properties 文件：</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="na">server.port</span><span class="o">=</span><span class="s">8990</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="na">spring.application.name</span><span class="o">=</span><span class="s">hystrix</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="c1">#注册到consul server上</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="na">spring.cloud.consul.host</span><span class="o">=</span><span class="s">localhost</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="na">spring.cloud.consul.port</span><span class="o">=</span><span class="s">8500</span>
</span></code></pre></div> </li> <li> <p>在 SpringApplication 入口类上加入开启断路器的注解：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="nd">@EnableDiscoveryClient</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="c1">//开启Hystrix服务熔断</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="nd">@EnableHystrix</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Hystrix8990Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">Hystrix8990Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>编写一个 Controller，使用 HystrixCommand 注解实现断路</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="nd">@RestController</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DemoController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LoggerFactory</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">DemoController</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/demo"</span><span class="p">)</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">    </span><span class="c1">//指定熔断时快速返回方法</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="nd">@HystrixCommand</span><span class="p">(</span><span class="n">fallbackMethod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"testBreakFall"</span><span class="p">)</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">testBreak</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">        </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"接收的Id为：{}"</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">"数据不合法"</span><span class="p">);</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"接收的Id为："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">testBreakFall</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"当前数据不合法："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>测试，访问 <a href="http://localhost:8990/demo?id=-1">localhost:8990/demo?id=-1</a> 和 <a href="http://localhost:8990/demo?id=1">localhost:8990/demo?id=1</a></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211107231830649.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211107231830649.png" alt="image-20211107231830649" style></a></p> </li> </ol> <p><strong>断路器的开启条件</strong></p> <p>当多次调用错误参数后，断路器会自动打开，此时正常调用也会出发断路器：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211107232033660.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211107232033660.png" alt="image-20211107232033660" style></a></p> <p>因为当达成 Hystrix 的打开条件后，断路器就会自动打开：</p> <ol> <li>当满足一定的阀值的时候（默认10秒内超过20个请求次数）</li> <li>当失败率达到一定的时候（默认10秒内超过50%的请求失败）</li> </ol> <p>当开启的时候，所有请求都不会进行转发。一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。</p> <p><strong>断路器流程</strong></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211107232403809.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211107232403809.png" alt="image-20211107232403809" style></a></p> <p><strong>默认的服务 FallBack 处理方法</strong></p> <p>如果为每一个服务方法开发一个降级，对于我们来说可能会出现大量的代码的冗余，不利于维护，这个时候就需要加入默认服务降级处理方法</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/default"</span><span class="p">)</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="nd">@HystrixCommand</span><span class="p">(</span><span class="n">defaultFallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"defaultFallback"</span><span class="p">)</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">defaultTest</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">"异常啦！"</span><span class="p">);</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="p">}</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">defaultFallback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">"此为默认响应"</span><span class="p">;</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="p">}</span>
</span></code></pre></div> <h4 id="623服务降级的实现">6.2.3、服务降级的实现<a class="headerlink" href="#623服务降级的实现" title="锚点链接">¶</a></h4> <ol> <li> <p>创建一个新的微服务：openfeignHystrix，并引入相关依赖：</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="nt">&lt;dependencies&gt;</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-consul-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></div> <p>因为 OpfenFeign 中包含了 Hystrix 依赖，所以无需再次引入：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211107235244640.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211107235244640.png" alt="image-20211107235244640" style></a></p> </li> <li> <p>配置一下 application.properties，并开启openfeign支持服务降级：</p> <div class="language-properties highlight"><span class="filename">Properties</span><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="na">server.port</span><span class="o">=</span><span class="s">8991</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="na">spring.application.name</span><span class="o">=</span><span class="s">openfeignHystrix</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="c1">#注册到consul server</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="na">spring.cloud.consul.port</span><span class="o">=</span><span class="s">8500</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="na">spring.cloud.consul.host</span><span class="o">=</span><span class="s">localhost</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="c1">#开启openfeign支持服务降级</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="na">feign.hystrix.enabled</span><span class="o">=</span><span class="s">true</span>
</span></code></pre></div> </li> <li> <p>编写入口类：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="nd">@EnableDiscoveryClient</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="c1">//开启OpenFeign调用</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="nd">@EnableFeignClients</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">OpenfeignHystrix8991Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">OpenfeignHystrix8991Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>编写 OpenFeign 客户端：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nd">@FeignClient</span><span class="p">(</span><span class="s">"hystrix"</span><span class="p">)</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">HystrixClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/demo"</span><span class="p">)</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">demo</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="s">"id"</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">);</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>开发 fallback 处理类：实现 HystrixClient，重写的方法就是对应的 fallback 处理</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HystrixFallBack</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">HystrixClient</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">demo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"当前服务不可用,请稍后再试,id:"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>在 OpenFeign 客户端中加入 Hystrix：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"hystrix"</span><span class="p">,</span><span class="w"> </span><span class="n">fallback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HystrixFallBack</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span></code></pre></div> </li> <li> <p>编写一个 Controller 测试：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nd">@RestController</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DemoController</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">    </span><span class="nd">@Autowired</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">HystrixClient</span><span class="w"> </span><span class="n">hystrixClient</span><span class="p">;</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"/test"</span><span class="p">)</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hystrixClient</span><span class="p">.</span><span class="na">demo</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"feignHystrix调用成功："</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="p">}</span>
</span></code></pre></div> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211108000721009.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211108000721009.png" alt="image-20211108000721009" style></a></p> </li> </ol> <h2 id="7服务网关组件">7、服务网关组件<a class="headerlink" href="#7服务网关组件" title="锚点链接">¶</a></h2> <p><strong>什么是服务网关？</strong></p> <p>网关统一服务入口，可方便实现对平台众多服务接口进行管控，对访问服务的身份认证、防报文重放与防数据篡改、功能调用的业务鉴权、响应数据的脱敏、流量与并发控制，甚至基于 API 调用的计量或者计费等等。</p> <p>网关 = 路由转发 + 过滤器。路由转发：接收一切外界请求，转发到后端的微服务上去；在服务网关中可以完成一系列的横切功能，例如权限校验、限流以及监控等，这些都可以通过过滤器完成。</p> <p><strong>为什么需要网关？</strong></p> <ul> <li>网关可以实现服务的统一管理</li> <li>网关可以解决微服务中通用代码的冗余问题（如权限控制、流量监控、限流等）</li> </ul> <p><strong>网关组件在微服务中架构</strong></p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211221221738529.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211221221738529.png" alt="image-20211221221738529" style></a></p> <h3 id="71gateway">7.1、Gateway<a class="headerlink" href="#71gateway" title="锚点链接">¶</a></h3> <p>这个项目提供了一个在 SpringMVC 之上构建 API 网关的库。SpringCloud Gateway 旨在提供一种简单而有效的方法来路由到 API，并为 API 提供横切关注点，比如：安全性、监控、度量和弹性。</p> <p><strong>特性</strong></p> <ul> <li>基于 SpringBoot 2.x 和 Spring WebFlux 和 Reactor 构建，响应式异步非阻塞 IO 模型</li> <li>动态路由</li> <li>请求过滤</li> </ul> <h4 id="711开发网关动态路由">7.1.1、开发网关动态路由<a class="headerlink" href="#711开发网关动态路由" title="锚点链接">¶</a></h4> <p>网关配置有两种方式：一种是快捷方式（Java 代码编写网关），一种是完全展开方式（配置文件方式）[推荐]。</p> <p><strong>配置文件方式：</strong></p> <ol> <li> <p>创建项目引入网关依赖：</p> <div class="language-xml highlight"><span class="filename">XML</span><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="nt">&lt;dependencies&gt;</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7" href="#__codelineno-61-7"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8" href="#__codelineno-61-8"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-consul-discovery<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9" href="#__codelineno-61-9"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10" href="#__codelineno-61-10"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11" href="#__codelineno-61-11"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12" href="#__codelineno-61-12"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13" href="#__codelineno-61-13"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14" href="#__codelineno-61-14"></a><span class="w">    </span><span class="cm">&lt;!--引入gateway网关依赖--&gt;</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15" href="#__codelineno-61-15"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16" href="#__codelineno-61-16"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17" href="#__codelineno-61-17"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-gateway<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18" href="#__codelineno-61-18"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19" href="#__codelineno-61-19"></a><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></div> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="nd">@SpringBootApplication</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a><span class="nd">@EnableDiscoveryClient</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Gateway8989Application</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="w">        </span><span class="n">SpringApplication</span><span class="p">.</span><span class="na">run</span><span class="p">(</span><span class="n">Gateway8989Application</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>编写 application.yml 配置文件：</p> <div class="language-yaml highlight"><span class="filename">YAML</span><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="nt">server</span><span class="p">:</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8989</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="nt">spring</span><span class="p">:</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">  </span><span class="nt">application</span><span class="p">:</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gateway</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="nt">consul</span><span class="p">:</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8500</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w">    </span><span class="nt">gateway</span><span class="p">:</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">      </span><span class="nt">routes</span><span class="p">:</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12" href="#__codelineno-63-12"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">order_route</span><span class="w">               </span><span class="c1"># 指定路由唯一标识</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13" href="#__codelineno-63-13"></a><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost:9996/</span><span class="w">   </span><span class="c1"># 指定路由服务的地址</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14" href="#__codelineno-63-14"></a><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15" href="#__codelineno-63-15"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Path=/order/**</span><span class="w">            </span><span class="c1"># 指定路由规则</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16" href="#__codelineno-63-16"></a>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17" href="#__codelineno-63-17"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">product_route</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18" href="#__codelineno-63-18"></a><span class="w">          </span><span class="nt">uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost:9993/</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19" href="#__codelineno-63-19"></a><span class="w">          </span><span class="nt">predicates</span><span class="p">:</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20" href="#__codelineno-63-20"></a><span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Path=/product/**</span>
</span></code></pre></div> </li> <li> <p>启动 Gateway 网关项目后发现抱错：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211226235723611.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211226235723611.png" alt="image-20211226235723611" style></a></p> <p>根据上面描述（Description）中信息了解到 GatewayAutoConfiguration 这个配置中找不到 ServerCodecConfig 这个Bean。</p> <p>从源码中得知 SpringBoot 在启动的时候会去加载它的配置，其中有一个叫做 GatewayClassPathWarningAutoConfiguration 的配置类中有这么一行代码：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211227001125725.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211227001125725.png" alt="image-20211227001125725" style></a></p> <p>翻译过来是：在 classpath 上发现 Spring MVC，此时与 Spring Cloud Gateway 不兼容。请删除 spring-boot-starter-web 依赖项。</p> <p>因为 Spring Cloud Gateway 是基于 Webflux 的，如果非要 Web 支持的话需要导入 <code>spring-boot-starter-webflux</code> 而不是 <code>spring-boot-start-web</code>。那我们直接把 pom.xml 中关于 <code>spring-boot-start-web</code> 模块的依赖去掉即可。</p> <p>再次启动成功启动：</p> <p><a class="glightbox" data-type="image" data-width="100%" data-height="auto" href="!assets/SpringCloud/image-20211227001927862.png" data-desc-position="bottom"><img src="!assets/SpringCloud/image-20211227001927862.png" alt="image-20211227001927862" style></a></p> </li> <li> <p>启动订单和商品服务，测试网关路由转发：</p> <p>测试通过网关访问订单服务: http://localhost:8989/order</p> <p>测试通过网关访问商品服务: http://localhost:8989/product</p> </li> </ol> <p><strong>Java 方式配置路由：</strong></p> <ol> <li> <p>编写 Gateway 配置类：</p> <div class="language-java highlight"><span class="filename">Java</span><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="cm">/**</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="cm"> * @author Orichalcos</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="cm"> */</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="nd">@Configuration</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">GatewayConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RouteLocator</span><span class="w"> </span><span class="nf">customRouteLocator</span><span class="p">(</span><span class="n">RouteLocatorBuilder</span><span class="w"> </span><span class="n">builder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">routes</span><span class="p">()</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">                </span><span class="p">.</span><span class="na">route</span><span class="p">(</span><span class="s">"category_route"</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="s">"/category/**"</span><span class="p">).</span><span class="na">uri</span><span class="p">(</span><span class="s">"http://localhost:9995"</span><span class="p">))</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="p">}</span>
</span></code></pre></div> </li> <li> <p>测试通过网关访问类别服务：http://localhost:8989/category</p> </li> </ol> <h4 id="712查看网关路由规则">7.1.2、查看网关路由规则<a class="headerlink" href="#712查看网关路由规则" title="锚点链接">¶</a></h4> <aside class="md-source-file"> <span class="md-source-file__fact"> <span class="md-icon" title="最后更新"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2026年1月22日 20:21:58 UTC">2026年1月22日 20:21:58</span> </span> <span class="md-source-file__fact"> <span class="md-icon" title="创建日期"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2021年4月26日 11:39:30 UTC">2021年4月26日 11:39:30</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type="button" class="md-top md-icon" data-md-component="top" hidden> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg> 回到页面顶部 </button> </main> <footer class="md-footer"> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> Made with <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener"> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.top", "navigation.indexes", "navigation.tracking", "navigation.instant", "navigation.path", "content.tabs.link", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src="../assets/javascripts/bundle.79ae519e.min.js"></script> <script src="../_javascripts/auto_title.js"></script>  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>